<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡æ¿åˆ†äº«å›¾ç”Ÿæˆæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .preview-area {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }
        .form-section {
            flex: 1;
            min-width: 350px;
        }
        .preview-section {
            flex: 1;
            text-align: center;
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #4A90E2;
        }
        textarea {
            height: 120px;
            resize: vertical;
            font-family: inherit;
        }
        button {
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .share-preview {
            max-width: 100%;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        .success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background: linear-gradient(135deg, #cce7ff 0%, #b3d9ff 100%);
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
            font-weight: 700;
        }
        .form-group {
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 15px;
        }
        .feature-badge {
            display: inline-block;
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .template-info {
            background: #f8f9fa;
            border-left: 4px solid #4A90E2;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¨ æ¨¡æ¿åˆ†äº«å›¾ç”Ÿæˆå™¨<span class="feature-badge">NEW</span></h1>
    
    <div class="template-info">
        <strong>âœ¨ åŸºäºç²¾ç¾è“è‰²æ¸å˜æ¨¡æ¿</strong><br>
        åŒ…å«æ ‡é¢˜åŒºåŸŸã€å†…å®¹å¡ç‰‡ã€äºŒç»´ç å’Œå“ç‰Œæ ‡è¯†ï¼Œå®Œç¾é€‚é…ç¤¾äº¤åª’ä½“åˆ†äº«
    </div>
    
    <div class="test-container">
        <div class="preview-area">
            <div class="form-section">
                <div class="form-group">
                    <label>ğŸ·ï¸ æ–°é—»æ ‡é¢˜</label>
                    <textarea id="titleInput" placeholder="è¾“å…¥æ–°é—»æ ‡é¢˜...">OpenAIå‘å¸ƒGPT-5ï¼šæ€§èƒ½é£è·ƒå¼æå‡ï¼Œå¤šæ¨¡æ€èƒ½åŠ›å…¨é¢å¢å¼º</textarea>
                </div>
                
                <div class="form-group">
                    <label>ğŸ“ æ–°é—»å†…å®¹</label>
                    <textarea id="contentInput" placeholder="è¾“å…¥æ–°é—»å†…å®¹...">OpenAIä»Šæ—¥æ­£å¼å‘å¸ƒäº†å¤‡å—æœŸå¾…çš„GPT-5æ¨¡å‹ï¼Œè¿™ä¸€é‡Œç¨‹ç¢‘å¼çš„æ›´æ–°å¸¦æ¥äº†å‰æ‰€æœªæœ‰çš„æ€§èƒ½æå‡ã€‚æ–°æ¨¡å‹åœ¨è‡ªç„¶è¯­è¨€ç†è§£ã€æ¨ç†èƒ½åŠ›å’Œå¤šæ¨¡æ€å¤„ç†æ–¹é¢éƒ½æœ‰æ˜¾è‘—è¿›æ­¥ï¼Œå¤„ç†é€Ÿåº¦æå‡30%ï¼Œå‡†ç¡®æ€§å¤§å¹…å¢å¼ºã€‚GPT-5æ”¯æŒæ›´é•¿çš„ä¸Šä¸‹æ–‡é•¿åº¦ï¼Œèƒ½å¤Ÿå¤„ç†å¤æ‚çš„å¤šè½®å¯¹è¯ï¼Œåœ¨ç¼–ç¨‹ã€æ•°å­¦ã€ç§‘å­¦ç ”ç©¶ç­‰ä¸“ä¸šé¢†åŸŸè¡¨ç°å°¤ä¸ºçªå‡ºã€‚</textarea>
                </div>
                
                <div class="form-group">
                    <label>ğŸ“… å‘å¸ƒæ—¶é—´</label>
                    <input type="datetime-local" id="dateInput" />
                </div>
                
                <div class="form-group">
                    <label>ğŸ“° æ–°é—»æ¥æº</label>
                    <input type="text" id="sourceInput" value="AIæ¨-ä¸“æ³¨AIç§‘æŠ€æ–°é—»" placeholder="è¾“å…¥æ–°é—»æ¥æº..." />
                </div>
                
                <button onclick="generateTemplateShare()" id="generateBtn">
                    ğŸš€ ç”Ÿæˆç²¾ç¾åˆ†äº«å›¾
                </button>
                
                <div id="status"></div>
            </div>
            
            <div class="preview-section">
                <h3 style="color: #333; margin-bottom: 20px;">ğŸ–¼ï¸ åˆ†äº«å›¾é¢„è§ˆ</h3>
                <div id="sharePreview">
                    <p style="color: #999; padding: 60px 20px; background: #f8f9fa; border-radius: 12px; border: 2px dashed #dee2e6;">
                        ç‚¹å‡»ç”ŸæˆæŒ‰é’®æŸ¥çœ‹ç²¾ç¾åˆ†äº«å›¾æ•ˆæœ
                    </p>
                </div>
                <button onclick="downloadShare()" id="downloadBtn" style="margin-top: 20px; display: none;">
                    ğŸ’¾ ä¸‹è½½åˆ†äº«å›¾
                </button>
            </div>
        </div>
    </div>

    <script>
        // è®¾ç½®é»˜è®¤æ—¶é—´ä¸ºå½“å‰æ—¶é—´
        document.getElementById('dateInput').value = new Date().toISOString().slice(0, 16);
        
        let currentShareData = null;

        // æ¨¡æ¿åˆ†äº«å›¾ç”ŸæˆæœåŠ¡
        class TemplateShareImageService {
            constructor() {
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                
                this.config = {
                    width: 800,
                    height: 1200,
                    
                    contentArea: {
                        x: 75,
                        y: 240,
                        width: 650,
                        height: 450,
                        borderRadius: 30,
                        backgroundColor: '#ffffff',
                        padding: 40
                    },
                    
                    bottomArea: {
                        y: 1030,
                        qrCode: {
                            x: 103,
                            y: 1033,
                            width: 170,
                            height: 170,
                            backgroundColor: '#666666',
                            borderRadius: 8
                        },
                        mascot: {
                            x: 530,
                            y: 1060
                        },
                        brand: {
                            x: 640,
                            y: 1120,
                            text: 'AIæ¨',
                            subtitle: 'å›½å†…å¤–AIæ–°é—»æ¨é€'
                        }
                    },
                    
                    fonts: {
                        title: {
                            size: 50,
                            color: '#ffffff',
                            family: '"Microsoft YaHei", "PingFang SC", sans-serif',
                            lineHeight: 70
                        },
                        content: {
                            size: 28,
                            color: '#333333',
                            family: '"Microsoft YaHei", "PingFang SC", sans-serif',
                            lineHeight: 42
                        },
                        qrText: {
                            size: 18,
                            color: '#666666',
                            family: '"Microsoft YaHei", sans-serif'
                        },
                        brand: {
                            size: 28,
                            color: '#333333',
                            family: '"Microsoft YaHei", sans-serif',
                            weight: 'bold'
                        },
                        brandSubtitle: {
                            size: 18,
                            color: '#666666',
                            family: '"Microsoft YaHei", sans-serif'
                        }
                    }
                };
            }

            async generateShareImage(newsData) {
                this.canvas.width = this.config.width;
                this.canvas.height = this.config.height;
                
                this.ctx.imageSmoothingEnabled = true;
                this.ctx.imageSmoothingQuality = 'high';
                
                try {
                    await this.drawBackground();
                    this.drawTitleArea(newsData.title);
                    this.drawContentCard(newsData.content);
                    await this.drawBottomArea(newsData.id);
                    this.drawBrandArea();
                    
                    return this.canvas.toDataURL('image/jpeg', 0.9);
                    
                } catch (error) {
                    console.error('åˆ†äº«å›¾ç”Ÿæˆå¤±è´¥:', error);
                    throw new Error('åˆ†äº«å›¾ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            }

            async drawBackground() {
                const gradient = this.ctx.createLinearGradient(0, 0, 0, this.config.height);
                gradient.addColorStop(0, '#4A90E2');
                gradient.addColorStop(0.5, '#357ABD');
                gradient.addColorStop(1, '#7FB3D3');
                
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.config.width, this.config.height);
                
                this.drawDecorativeCurves();
            }

            drawDecorativeCurves() {
                this.ctx.save();
                
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                this.ctx.beginPath();
                this.ctx.moveTo(0, 800);
                this.ctx.quadraticCurveTo(400, 900, 800, 850);
                this.ctx.lineTo(800, 1200);
                this.ctx.lineTo(0, 1200);
                this.ctx.closePath();
                this.ctx.fill();
                
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
                this.ctx.beginPath();
                this.ctx.moveTo(600, 0);
                this.ctx.quadraticCurveTo(750, 300, 650, 600);
                this.ctx.lineTo(800, 600);
                this.ctx.lineTo(800, 0);
                this.ctx.closePath();
                this.ctx.fill();
                
                this.ctx.restore();
            }

            drawTitleArea(title) {
                const { fonts } = this.config;
                
                let displayTitle = title;
                if (title.length > 12) {
                    displayTitle = title.substring(0, 12);
                }
                
                this.ctx.fillStyle = fonts.title.color;
                this.ctx.font = `bold ${fonts.title.size}px ${fonts.title.family}`;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                
                this.ctx.fillText(displayTitle, this.config.width / 2, 140);
            }

            drawContentCard(content) {
                const { contentArea, fonts } = this.config;
                
                this.drawRoundedRect(
                    contentArea.x,
                    contentArea.y,
                    contentArea.width,
                    contentArea.height,
                    contentArea.borderRadius,
                    contentArea.backgroundColor
                );
                
                const maxContentLength = 120;
                let displayContent = content;
                if (content.length > maxContentLength) {
                    displayContent = content.substring(0, maxContentLength) + '...';
                }
                
                this.ctx.fillStyle = fonts.content.color;
                this.ctx.font = `${fonts.content.size}px ${fonts.content.family}`;
                this.ctx.textAlign = 'left';
                this.ctx.textBaseline = 'top';
                
                const lines = this.wrapText(
                    displayContent,
                    contentArea.width - contentArea.padding * 2,
                    fonts.content.size
                );
                
                const startY = contentArea.y + contentArea.padding;
                lines.slice(0, 10).forEach((line, index) => {
                    this.ctx.fillText(
                        line,
                        contentArea.x + contentArea.padding,
                        startY + index * fonts.content.lineHeight
                    );
                });
            }

            async drawBottomArea(newsId) {
                const { bottomArea } = this.config;
                
                this.drawRoundedRect(
                    bottomArea.qrCode.x,
                    bottomArea.qrCode.y,
                    bottomArea.qrCode.width,
                    bottomArea.qrCode.height,
                    bottomArea.qrCode.borderRadius,
                    bottomArea.qrCode.backgroundColor
                );
                
                try {
                    await this.drawQRCode(newsId);
                } catch (error) {
                    this.drawQRPlaceholder();
                }
                
                this.ctx.fillStyle = this.config.fonts.qrText.color;
                this.ctx.font = `${this.config.fonts.qrText.size}px ${this.config.fonts.qrText.family}`;
                this.ctx.textAlign = 'center';
                this.ctx.fillText(
                    'é•¿æŒ‰è¯†åˆ«äºŒç»´ç é˜…è¯»æ–°é—»',
                    bottomArea.qrCode.x + bottomArea.qrCode.width / 2,
                    bottomArea.qrCode.y + bottomArea.qrCode.height + 25
                );
            }

            async drawQRCode(newsId) {
                const { bottomArea } = this.config;
                const qrSize = 120;
                
                const newsUrl = `https://news.aipush.fun/#/news/${newsId}`;
                
                const qrApis = [
                    `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent(newsUrl)}&format=png&margin=1&ecc=H`,
                    `https://quickchart.io/qr?text=${encodeURIComponent(newsUrl)}&size=${qrSize}&format=png&ecLevel=H&margin=1`
                ];
                
                for (const apiUrl of qrApis) {
                    try {
                        const img = await this.loadImageWithTimeout(apiUrl, 5000);
                        
                        const qrX = bottomArea.qrCode.x + (bottomArea.qrCode.width - qrSize) / 2;
                        const qrY = bottomArea.qrCode.y + (bottomArea.qrCode.height - qrSize) / 2;
                        
                        this.ctx.drawImage(img, qrX, qrY, qrSize, qrSize);
                        return;
                    } catch (error) {
                        continue;
                    }
                }
                
                throw new Error('æ‰€æœ‰äºŒç»´ç APIéƒ½å¤±è´¥');
            }

            drawQRPlaceholder() {
                const { bottomArea, fonts } = this.config;
                
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = `bold 24px ${fonts.qrText.family}`;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                
                this.ctx.fillText(
                    'äºŒç»´ç ',
                    bottomArea.qrCode.x + bottomArea.qrCode.width / 2,
                    bottomArea.qrCode.y + bottomArea.qrCode.height / 2
                );
            }

            drawBrandArea() {
                const { bottomArea, fonts } = this.config;
                
                // æ©™è‰²å‰ç¥¥ç‰©å ä½ç¬¦
                this.ctx.fillStyle = '#FF8C42';
                this.ctx.beginPath();
                this.ctx.arc(bottomArea.mascot.x, bottomArea.mascot.y, 25, 0, 2 * Math.PI);
                this.ctx.fill();
                
                // å“ç‰Œåç§°
                this.ctx.fillStyle = fonts.brand.color;
                this.ctx.font = `bold ${fonts.brand.size}px ${fonts.brand.family}`;
                this.ctx.textAlign = 'center';
                this.ctx.fillText('AIæ¨', bottomArea.brand.x, bottomArea.brand.y);
                
                // å“ç‰Œå‰¯æ ‡é¢˜
                this.ctx.fillStyle = fonts.brandSubtitle.color;
                this.ctx.font = `${fonts.brandSubtitle.size}px ${fonts.brandSubtitle.family}`;
                this.ctx.fillText('å›½å†…å¤–AIæ–°é—»æ¨é€', bottomArea.brand.x, bottomArea.brand.y + 25);
            }

            drawRoundedRect(x, y, width, height, radius, fillStyle) {
                this.ctx.save();
                this.ctx.fillStyle = fillStyle;
                this.ctx.beginPath();
                this.ctx.moveTo(x + radius, y);
                this.ctx.lineTo(x + width - radius, y);
                this.ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
                this.ctx.lineTo(x + width, y + height - radius);
                this.ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                this.ctx.lineTo(x + radius, y + height);
                this.ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
                this.ctx.lineTo(x, y + radius);
                this.ctx.quadraticCurveTo(x, y, x + radius, y);
                this.ctx.closePath();
                this.ctx.fill();
                this.ctx.restore();
            }

            wrapText(text, maxWidth, fontSize) {
                const lines = [];
                let currentLine = '';
                
                for (let i = 0; i < text.length; i++) {
                    const testLine = currentLine + text[i];
                    const metrics = this.ctx.measureText(testLine);
                    
                    if (metrics.width > maxWidth && currentLine !== '') {
                        lines.push(currentLine);
                        currentLine = text[i];
                    } else {
                        currentLine = testLine;
                    }
                }
                
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                return lines;
            }

            loadImageWithTimeout(src, timeout = 5000) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    const timer = setTimeout(() => {
                        reject(new Error('å›¾ç‰‡åŠ è½½è¶…æ—¶'));
                    }, timeout);
                    
                    img.onload = () => {
                        clearTimeout(timer);
                        resolve(img);
                    };
                    
                    img.onerror = () => {
                        clearTimeout(timer);
                        reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
                    };
                    
                    img.src = src;
                });
            }

            downloadShareImage(dataUrl, filename = 'ai-news-share.jpg') {
                const link = document.createElement('a');
                link.download = filename;
                link.href = dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        const templateService = new TemplateShareImageService();

        async function generateTemplateShare() {
            const generateBtn = document.getElementById('generateBtn');
            const status = document.getElementById('status');
            const preview = document.getElementById('sharePreview');
            const downloadBtn = document.getElementById('downloadBtn');
            
            if (generateBtn.disabled) return;
            
            generateBtn.disabled = true;
            generateBtn.textContent = 'ğŸ”„ ç”Ÿæˆä¸­...';
            status.innerHTML = '<div class="loading">â³ æ­£åœ¨ç”Ÿæˆç²¾ç¾åˆ†äº«å›¾ï¼Œè¯·ç¨å€™...</div>';
            
            try {
                const newsData = {
                    id: `news_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    title: document.getElementById('titleInput').value || 'é»˜è®¤æ–°é—»æ ‡é¢˜',
                    content: document.getElementById('contentInput').value || 'é»˜è®¤æ–°é—»å†…å®¹',
                    publishedAt: document.getElementById('dateInput').value,
                    source: document.getElementById('sourceInput').value || 'AIæ¨'
                };
                
                const imageResult = await templateService.generateShareImage(newsData);
                currentShareData = { imageResult, newsData };
                
                preview.innerHTML = `<img src="${imageResult}" class="share-preview" alt="ç”Ÿæˆçš„åˆ†äº«å›¾" />`;
                status.innerHTML = '<div class="success">âœ… ç²¾ç¾åˆ†äº«å›¾ç”ŸæˆæˆåŠŸï¼å®Œç¾é€‚é…ç¤¾äº¤åª’ä½“åˆ†äº«</div>';
                downloadBtn.style.display = 'block';
                
            } catch (error) {
                status.innerHTML = '<div class="error">âŒ ç”Ÿæˆå¤±è´¥ï¼š' + error.message + '</div>';
                preview.innerHTML = '<p style="color: #999; padding: 60px 20px; background: #f8f9fa; border-radius: 12px; border: 2px dashed #dee2e6;">ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•</p>';
                downloadBtn.style.display = 'none';
            }
            
            generateBtn.disabled = false;
            generateBtn.textContent = 'ğŸš€ ç”Ÿæˆç²¾ç¾åˆ†äº«å›¾';
        }

        function downloadShare() {
            if (!currentShareData) return;
            
            templateService.downloadShareImage(
                currentShareData.imageResult, 
                `AIæ¨åˆ†äº«å›¾_${currentShareData.newsData.title.substring(0, 15)}_${new Date().getTime()}.jpg`
            );
        }
    </script>
</body>
</html>