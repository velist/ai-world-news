<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模板分享图生成测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .preview-area {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }
        .form-section {
            flex: 1;
            min-width: 350px;
        }
        .preview-section {
            flex: 1;
            text-align: center;
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #4A90E2;
        }
        textarea {
            height: 120px;
            resize: vertical;
            font-family: inherit;
        }
        button {
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .share-preview {
            max-width: 100%;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        .success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background: linear-gradient(135deg, #cce7ff 0%, #b3d9ff 100%);
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
            font-weight: 700;
        }
        .form-group {
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 15px;
        }
        .feature-badge {
            display: inline-block;
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .template-info {
            background: #f8f9fa;
            border-left: 4px solid #4A90E2;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>🎯 真实模板分享图生成器 - 终极版 v3.0<span class="feature-badge">FIXED</span></h1>
    
    <div class="template-info">
        <strong>✨ 基于精美蓝色渐变模板</strong><br>
        包含标题区域、内容卡片、二维码和品牌标识，完美适配社交媒体分享
    </div>
    
    <div class="test-container">
        <div class="preview-area">
            <div class="form-section">
                <div class="form-group">
                    <label>🏷️ 新闻标题</label>
                    <textarea id="titleInput" placeholder="输入新闻标题...">OpenAI发布GPT-5：性能飞跃式提升，多模态能力全面增强</textarea>
                </div>
                
                <div class="form-group">
                    <label>📝 新闻内容</label>
                    <textarea id="contentInput" placeholder="输入新闻内容...">OpenAI今日正式发布了备受期待的GPT-5模型，这一里程碑式的更新带来了前所未有的性能提升。新模型在自然语言理解、推理能力和多模态处理方面都有显著进步，处理速度提升30%，准确性大幅增强。GPT-5支持更长的上下文长度，能够处理复杂的多轮对话，在编程、数学、科学研究等专业领域表现尤为突出。</textarea>
                </div>
                
                <div class="form-group">
                    <label>📅 发布时间</label>
                    <input type="datetime-local" id="dateInput" />
                </div>
                
                <div class="form-group">
                    <label>📰 新闻来源</label>
                    <input type="text" id="sourceInput" value="AI推-专注AI科技新闻" placeholder="输入新闻来源..." />
                </div>
                
                <button onclick="generateTemplateShare()" id="generateBtn">
                    🚀 生成精美分享图
                </button>
                
                <div id="status"></div>
            </div>
            
            <div class="preview-section">
                <h3 style="color: #333; margin-bottom: 20px;">🖼️ 分享图预览</h3>
                <div id="sharePreview">
                    <p style="color: #999; padding: 60px 20px; background: #f8f9fa; border-radius: 12px; border: 2px dashed #dee2e6;">
                        点击生成按钮查看精美分享图效果
                    </p>
                </div>
                <button onclick="downloadShare()" id="downloadBtn" style="margin-top: 20px; display: none;">
                    💾 下载分享图
                </button>
            </div>
        </div>
    </div>

    <script>
        // 设置默认时间为当前时间
        document.getElementById('dateInput').value = new Date().toISOString().slice(0, 16);
        
        let currentShareData = null;

        // 模板分享图生成服务
        class TemplateShareImageService {
            constructor() {
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                
                this.config = {
                    width: 800,
                    height: 1200,
                    
                    contentArea: {
                        x: 40,
                        y: 240,
                        width: 720,
                        height: 450,
                        borderRadius: 30,
                        backgroundColor: '#ffffff',
                        padding: 40
                    },
                    
                    bottomArea: {
                        y: 1030,
                        qrCode: {
                            x: 100,
                            y: 1030,
                            width: 180,
                            height: 180,
                            backgroundColor: '#666666',
                            borderRadius: 8
                        },
                        mascot: {
                            x: 530,
                            y: 1060
                        },
                        brand: {
                            x: 640,
                            y: 1120,
                            text: 'AI推',
                            subtitle: '国内外AI新闻推送'
                        }
                    },
                    
                    fonts: {
                        title: {
                            size: 96,
                            color: '#ffffff',
                            family: '"Microsoft YaHei", "PingFang SC", sans-serif',
                            lineHeight: 110
                        },
                        content: {
                            size: 42,
                            color: '#333333',
                            family: '"Microsoft YaHei", "PingFang SC", sans-serif',
                            lineHeight: 58
                        },
                        qrText: {
                            size: 18,
                            color: '#666666',
                            family: '"Microsoft YaHei", sans-serif'
                        },
                        brand: {
                            size: 28,
                            color: '#333333',
                            family: '"Microsoft YaHei", sans-serif',
                            weight: 'bold'
                        },
                        brandSubtitle: {
                            size: 18,
                            color: '#666666',
                            family: '"Microsoft YaHei", sans-serif'
                        }
                    }
                };
            }

            async generateShareImage(newsData) {
                this.canvas.width = this.config.width;
                this.canvas.height = this.config.height;
                
                this.ctx.imageSmoothingEnabled = true;
                this.ctx.imageSmoothingQuality = 'high';
                
                try {
                    // 1. 首先加载模板背景图片
                    await this.loadTemplateBackground();
                    
                    // 2. 在蓝色标题区域叠加标题
                    this.overlayTitle(newsData.title);
                    
                    // 3. 在白色内容区域叠加内容
                    this.overlayContent(newsData.content);
                    
                    // 4. 在灰色占位符上叠加二维码
                    await this.overlayQRCode(newsData.id);
                    
                    return this.canvas.toDataURL('image/jpeg', 0.9);
                    
                } catch (error) {
                    console.error('分享图生成失败:', error);
                    throw new Error('分享图生成失败，请稍后重试');
                }
            }

            async loadTemplateBackground() {
                console.log('🔍 开始加载模板图片...');
                
                // 尝试多个可能的模板路径和方法
                const templateUrls = [
                    './share-template-blank.jpg',  // 原始路径
                    '/share-template-blank.jpg',   // 绝对路径
                    './新闻图分享示意-空白.jpg',      // 用户期望的模板名称
                    '/新闻图分享示意-空白.jpg'       // 用户期望的模板绝对路径
                ];
                
                for (const templateUrl of templateUrls) {
                    try {
                        console.log(`📡 尝试加载模板图片URL: ${templateUrl}`);
                        
                        // 不使用时间戳破坏缓存，避免404错误
                        const templateImg = await this.loadImageWithTimeout(templateUrl, 10000);
                        console.log(`✅ 模板图片加载成功！路径: ${templateUrl}, 尺寸: ${templateImg.width} x ${templateImg.height}`);
                        
                        // 将模板图片绘制到canvas上，确保完全覆盖
                        this.ctx.drawImage(templateImg, 0, 0, this.config.width, this.config.height);
                        console.log('🎨 模板背景绘制完成');
                        return; // 成功加载，退出方法
                        
                    } catch (error) {
                        console.warn(`⚠️ 模板加载失败 [${templateUrl}]:`, error.message);
                        continue; // 尝试下一个URL
                    }
                }
                
                // 所有模板路径都失败，使用备用背景
                console.error('❌ 所有模板图片路径都加载失败，使用备用蓝色背景');
                this.drawFallbackBackground();
            }

            drawFallbackBackground() {
                console.log('🔄 使用备用蓝色背景');
                const gradient = this.ctx.createLinearGradient(0, 0, 0, this.config.height);
                gradient.addColorStop(0, '#4A90E2');
                gradient.addColorStop(0.5, '#357ABD');
                gradient.addColorStop(1, '#7FB3D3');
                
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.config.width, this.config.height);
            }

            overlayTitle(title) {
                const { fonts } = this.config;
                console.log('📝 开始绘制标题:', title);
                
                // 在蓝色标题区域叠加标题
                this.ctx.fillStyle = fonts.title.color;
                this.ctx.font = `bold ${fonts.title.size}px ${fonts.title.family}`;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                
                // 标题区域：蓝色渐变区域中央
                const titleY = 150; // 蓝色标题区域中心Y坐标
                
                // 如果标题过长，分行显示
                if (title.length > 20) {
                    const midPoint = Math.floor(title.length / 2);
                    const line1 = title.substring(0, midPoint);
                    const line2 = title.substring(midPoint);
                    
                    this.ctx.fillText(line1, this.config.width / 2, titleY - 30);
                    this.ctx.fillText(line2, this.config.width / 2, titleY + 30);
                    console.log('📝 双行标题绘制完成');
                } else {
                    this.ctx.fillText(title, this.config.width / 2, titleY);
                    console.log('📝 单行标题绘制完成');
                }
            }

            overlayContent(content) {
                const { fonts, contentArea } = this.config;
                
                // 在白色内容卡片区域叠加内容
                this.ctx.fillStyle = fonts.content.color;
                this.ctx.font = `${fonts.content.size}px ${fonts.content.family}`;
                this.ctx.textAlign = 'left';
                this.ctx.textBaseline = 'top';
                
                // 限制内容长度
                const maxContentLength = 150;
                let displayContent = content;
                if (content.length > maxContentLength) {
                    displayContent = content.substring(0, maxContentLength) + '...';
                }
                
                // 文字换行处理
                const lines = this.wrapText(
                    displayContent,
                    contentArea.width - contentArea.padding * 2,
                    fonts.content.size
                );
                
                // 在白色卡片区域内绘制文字
                const startY = contentArea.y + contentArea.padding;
                lines.slice(0, 8).forEach((line, index) => {
                    this.ctx.fillText(
                        line,
                        contentArea.x + contentArea.padding,
                        startY + index * fonts.content.lineHeight
                    );
                });
            }

            async overlayQRCode(newsId) {
                const { bottomArea } = this.config;
                const qrSize = 180;
                
                const newsUrl = `https://news.aipush.fun/#/news/${newsId}`;
                
                const qrApis = [
                    `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent(newsUrl)}&format=png&margin=0&ecc=H`,
                    `https://quickchart.io/qr?text=${encodeURIComponent(newsUrl)}&size=${qrSize}&format=png&ecLevel=H&margin=0`
                ];
                
                // 尝试生成并叠加二维码到灰色占位符上
                for (const apiUrl of qrApis) {
                    try {
                        const qrImg = await this.loadImageWithTimeout(apiUrl, 5000);
                        
                        // 直接覆盖灰色占位符区域
                        this.ctx.drawImage(
                            qrImg, 
                            bottomArea.qrCode.x, 
                            bottomArea.qrCode.y, 
                            qrSize, 
                            qrSize
                        );
                        return;
                    } catch (error) {
                        continue;
                    }
                }
                
                // 如果二维码生成失败，在占位符上显示"加载中"
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = 'bold 20px Microsoft YaHei';
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText(
                    '二维码加载中',
                    bottomArea.qrCode.x + qrSize / 2,
                    bottomArea.qrCode.y + qrSize / 2
                );
            }

            wrapText(text, maxWidth, fontSize) {
                const lines = [];
                let currentLine = '';
                
                for (let i = 0; i < text.length; i++) {
                    const testLine = currentLine + text[i];
                    const metrics = this.ctx.measureText(testLine);
                    
                    if (metrics.width > maxWidth && currentLine !== '') {
                        lines.push(currentLine);
                        currentLine = text[i];
                    } else {
                        currentLine = testLine;
                    }
                }
                
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                return lines;
            }

            loadImageWithTimeout(src, timeout = 10000) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    
                    // 重要：设置跨域属性 - 匿名访问以避免跨域问题
                    img.crossOrigin = 'anonymous';
                    
                    const timer = setTimeout(() => {
                        reject(new Error(`图片加载超时: ${src}`));
                    }, timeout);
                    
                    img.onload = () => {
                        clearTimeout(timer);
                        console.log(`🖼️ 图片加载成功: ${src} (${img.width}×${img.height})`);
                        resolve(img);
                    };
                    
                    img.onerror = () => {
                        clearTimeout(timer);
                        reject(new Error(`图片加载失败: ${src}`));
                    };
                    
                    // 添加额外的调试信息
                    console.log(`🚀 开始加载图片: ${src}`);
                    img.src = src;
                });
            }

            downloadShareImage(dataUrl, filename = 'ai-news-share.jpg') {
                const link = document.createElement('a');
                link.download = filename;
                link.href = dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // 真实模板分享图服务 - 终极版
        class RealTemplateShareImageService {
            constructor() {
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                
                // 设置Canvas尺寸匹配模板
                this.canvas.width = 800;
                this.canvas.height = 1200;
                
                console.log('🎯 真实模板服务初始化完成，Canvas尺寸: 800x1200');
            }

            async generateShareImage(newsData) {
                console.log('🚀 开始生成真实模板分享图...');
                console.log(`📋 数据: 标题="${newsData.title.substring(0, 30)}..."，内容="${newsData.content.substring(0, 50)}..."`);
                
                try {
                    // 步骤1: 加载真实模板图片作为背景
                    console.log('📸 步骤1: 加载真实模板图片背景');
                    await this.loadRealTemplateBackground();
                    
                    // 步骤2: 在蓝色标题区域叠加标题
                    console.log('🏷️ 步骤2: 叠加标题文字');
                    this.overlayTitleText(newsData.title);
                    
                    // 步骤3: 在白色内容区域叠加内容
                    console.log('📝 步骤3: 叠加内容文字');
                    this.overlayContentText(newsData.content);
                    
                    // 步骤4: 生成并叠加二维码
                    console.log('🔲 步骤4: 生成并叠加二维码');
                    await this.overlayQRCode(newsData.id);
                    
                    const result = this.canvas.toDataURL('image/jpeg', 0.92);
                    console.log('✅ 真实模板分享图生成完成！');
                    
                    return result;
                    
                } catch (error) {
                    console.error(`❌ 生成失败: ${error.message}`);
                    throw error;
                }
            }

            async loadRealTemplateBackground() {
                // 尝试加载模板图片的多个可能路径
                const templatePaths = [
                    './新闻图分享示意-空白.jpg',
                    './share-template-blank.jpg',
                    '../新闻图分享示意-空白.jpg',
                    '../share-template-blank.jpg'
                ];
                
                for (const path of templatePaths) {
                    try {
                        console.log(`🔍 尝试加载模板: ${path}`);
                        const templateImg = await this.loadImageWithTimeout(path, 8000);
                        
                        // 成功加载，绘制到Canvas
                        this.ctx.drawImage(templateImg, 0, 0, 800, 1200);
                        console.log(`✅ 模板加载成功: ${path}，尺寸: ${templateImg.width}x${templateImg.height}`);
                        return; // 成功加载，退出函数
                        
                    } catch (error) {
                        console.log(`⚠️ 模板路径失败: ${path} - ${error.message}`);
                        continue;
                    }
                }
                
                // 所有路径都失败，抛出错误
                throw new Error('无法加载任何模板图片路径');
            }

            overlayTitleText(title) {
                console.log('🎨 开始绘制标题文字');
                
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = 'bold 72px "Microsoft YaHei", "PingFang SC", sans-serif';
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                
                // 标题区域：蓝色背景区域上方，Y坐标根据模板调整
                const titleY = 120; // 调整到蓝色区域上方
                
                // 如果标题过长，智能分行
                const maxCharsPerLine = 15; // 减少每行字符数
                if (title.length > maxCharsPerLine) {
                    const midPoint = title.indexOf('：') > 0 && title.indexOf('：') < maxCharsPerLine + 3 
                        ? title.indexOf('：') + 1 
                        : Math.floor(title.length / 2);
                    
                    const line1 = title.substring(0, midPoint).trim();
                    const line2 = title.substring(midPoint).trim();
                    
                    this.ctx.fillText(line1, 400, titleY - 40); // 增加行间距
                    this.ctx.fillText(line2, 400, titleY + 40);
                    console.log(`📝 标题分为两行: "${line1}" 和 "${line2}"`);
                } else {
                    this.ctx.fillText(title, 400, titleY);
                    console.log(`📝 单行标题: "${title}"`);
                }
            }

            overlayContentText(content) {
                console.log('📄 开始绘制内容文字');
                
                this.ctx.fillStyle = '#333333';
                this.ctx.font = '36px "Microsoft YaHei", "PingFang SC", sans-serif';
                this.ctx.textAlign = 'left';
                this.ctx.textBaseline = 'top';
                
                // 根据真实模板精确定位内容区域：白色卡片内
                const contentX = 120; // 白色卡片左边距
                const contentY = 280; // 白色卡片顶部Y坐标
                const maxWidth = 560; // 白色卡片内部宽度
                const lineHeight = 48; // 增大行高以适应大字体
                
                // 限制内容长度，确保显示效果
                const maxContentLength = 160;
                let displayContent = content;
                if (content.length > maxContentLength) {
                    displayContent = content.substring(0, maxContentLength) + '...';
                }
                
                // 文字自动换行
                const lines = this.wrapText(displayContent, maxWidth);
                console.log(`📝 内容分为 ${lines.length} 行显示`);
                
                // 绘制每一行（最多8行以确保不超出白色卡片区域）
                lines.slice(0, 8).forEach((line, index) => {
                    const y = contentY + (index * lineHeight);
                    this.ctx.fillText(line, contentX, y);
                });
            }

            async overlayQRCode(newsId) {
                console.log('🔲 开始生成二维码');
                
                // 根据真实模板精确定位二维码，完全覆盖灰色"二维码"占位符
                const qrSize = 175; // 增大尺寸以完全覆盖
                const qrX = 103; // 精确对齐灰色占位符左边缘
                const qrY = 1035; // 精确对齐灰色占位符顶部
                
                const newsUrl = `https://news.aipush.fun/#/news/${newsId}`;
                console.log(`🔗 二维码URL: ${newsUrl}`);
                console.log(`📍 二维码位置: (${qrX}, ${qrY})，尺寸: ${qrSize}x${qrSize}`);
                
                const qrApis = [
                    `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent(newsUrl)}&format=png&margin=0&ecc=H&color=000000&bgcolor=ffffff`,
                    `https://quickchart.io/qr?text=${encodeURIComponent(newsUrl)}&size=${qrSize}&format=png&ecLevel=H&margin=0&dark=000000&light=ffffff`
                ];
                
                for (const apiUrl of qrApis) {
                    try {
                        console.log(`🌐 尝试二维码API: ${apiUrl.split('?')[0]}`);
                        const qrImg = await this.loadImageWithTimeout(apiUrl, 6000);
                        
                        // 直接覆盖到灰色二维码占位符上
                        this.ctx.drawImage(qrImg, qrX, qrY, qrSize, qrSize);
                        console.log(`✅ 二维码生成成功，完全覆盖占位符`);
                        return;
                        
                    } catch (error) {
                        console.log(`⚠️ 二维码API失败: ${error.message}`);
                        continue;
                    }
                }
                
                // 如果所有API都失败，显示占位文字
                console.log('⚠️ 所有二维码API都失败，显示占位符');
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = 'bold 20px "Microsoft YaHei"';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('二维码生成中', qrX + qrSize/2, qrY + qrSize/2);
            }

            wrapText(text, maxWidth) {
                const lines = [];
                let currentLine = '';
                
                for (let i = 0; i < text.length; i++) {
                    const testLine = currentLine + text[i];
                    const metrics = this.ctx.measureText(testLine);
                    
                    if (metrics.width > maxWidth && currentLine !== '') {
                        lines.push(currentLine);
                        currentLine = text[i];
                    } else {
                        currentLine = testLine;
                    }
                }
                
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                return lines;
            }

            loadImageWithTimeout(src, timeout = 8000) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    const timer = setTimeout(() => {
                        reject(new Error(`图片加载超时: ${src}`));
                    }, timeout);
                    
                    img.onload = () => {
                        clearTimeout(timer);
                        resolve(img);
                    };
                    
                    img.onerror = () => {
                        clearTimeout(timer);
                        reject(new Error(`图片加载失败: ${src}`));
                    };
                    
                    img.src = src;
                });
            }

            downloadShareImage(dataUrl, filename = 'ai-news-share.jpg') {
                const link = document.createElement('a');
                link.download = filename;
                link.href = dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        const templateService = new RealTemplateShareImageService();

        async function generateTemplateShare() {
            console.log('🎯 生成真实模板分享图开始 - 版本 v3.0');
            const generateBtn = document.getElementById('generateBtn');
            const status = document.getElementById('status');
            const preview = document.getElementById('sharePreview');
            const downloadBtn = document.getElementById('downloadBtn');
            
            if (generateBtn.disabled) return;
            
            generateBtn.disabled = true;
            generateBtn.textContent = '🔄 生成中...';
            status.innerHTML = '<div class="loading">⏳ 正在生成真实模板分享图，请稍候...</div>';
            
            try {
                const newsData = {
                    id: `news_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    title: document.getElementById('titleInput').value || '默认新闻标题',
                    content: document.getElementById('contentInput').value || '默认新闻内容',
                    publishedAt: document.getElementById('dateInput').value,
                    source: document.getElementById('sourceInput').value || 'AI推'
                };
                
                console.log('📋 新闻数据:', newsData);
                const imageResult = await templateService.generateShareImage(newsData);
                currentShareData = { imageResult, newsData };
                
                preview.innerHTML = `<img src="${imageResult}" class="share-preview" alt="真实模板分享图" />`;
                status.innerHTML = '<div class="success">✅ 真实模板分享图生成成功！完美使用您的模板背景</div>';
                downloadBtn.style.display = 'block';
                console.log('✅ 真实模板分享图生成完成');
                
            } catch (error) {
                console.error('❌ 生成过程出错:', error);
                status.innerHTML = '<div class="error">❌ 生成失败：' + error.message + '</div>';
                preview.innerHTML = '<p style="color: #999; padding: 60px 20px; background: #f8f9fa; border-radius: 12px; border: 2px dashed #dee2e6;">生成失败，请重试</p>';
                downloadBtn.style.display = 'none';
            }
            
            generateBtn.disabled = false;
            generateBtn.textContent = '🚀 生成真实模板分享图';
        }

        function downloadShare() {
            if (!currentShareData) return;
            
            templateService.downloadShareImage(
                currentShareData.imageResult, 
                `AI推分享图_${currentShareData.newsData.title.substring(0, 15)}_${new Date().getTime()}.jpg`
            );
        }
    </script>
</body>
</html>