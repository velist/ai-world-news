name: è·å–AIæ–°é—»å¹¶æ›´æ–°

on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆä½¿ç”¨UTCæ—¶é—´ï¼‰
    - cron: '0 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  fetch-and-update-news:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm install

      - name: è·å–å›½é™…æ–°é—»æ•°æ®
        env:
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          NEWSDATA_API_KEY: ${{ secrets.NEWSDATA_API_KEY }}
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
          CURRENTS_API_KEY: ${{ secrets.CURRENTS_API_KEY }}
          SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
          TENCENT_SECRET_ID: ${{ secrets.TENCENT_SECRET_ID }}
          TENCENT_SECRET_KEY: ${{ secrets.TENCENT_SECRET_KEY }}
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
          VOLC_API_KEY: ${{ secrets.VOLC_API_KEY }}
        run: node scripts/fetch-news.js

      - name: è·å–RSSå›½å†…æ–°é—»æ•°æ®
        run: node scripts/simple-aggregator.js

      - name: ç”ŸæˆRSS feed
        run: node scripts/generate-feed.js

      - name: é…ç½®Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: æäº¤æ›´æ–°çš„æ–°é—»æ•°æ®
        run: |
          # ç¡®ä¿å·¥ä½œç›®å½•å¹²å‡€
          git stash || true
          git fetch origin main
          git checkout main
          git pull origin main
          
          # é‡æ–°è¿è¡Œæ–°é—»è·å–ä»¥ç¡®ä¿æ•°æ®æ˜¯æœ€æ–°çš„
          ZHIPU_API_KEY="${{ secrets.ZHIPU_API_KEY }}" VOLC_API_KEY="${{ secrets.VOLC_API_KEY }}" NEWS_API_KEY="${{ secrets.NEWS_API_KEY }}" NEWSDATA_API_KEY="${{ secrets.NEWSDATA_API_KEY }}" GNEWS_API_KEY="${{ secrets.GNEWS_API_KEY }}" CURRENTS_API_KEY="${{ secrets.CURRENTS_API_KEY }}" SILICONFLOW_API_KEY="${{ secrets.SILICONFLOW_API_KEY }}" TENCENT_SECRET_ID="${{ secrets.TENCENT_SECRET_ID }}" TENCENT_SECRET_KEY="${{ secrets.TENCENT_SECRET_KEY }}" node scripts/fetch-news.js
          node scripts/simple-aggregator.js
          node scripts/generate-feed.js
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet public/news-data.json; then
            echo "æ–°é—»æ•°æ®æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            echo "æ£€æµ‹åˆ°æ–°é—»æ•°æ®æ›´æ–°ï¼Œå‡†å¤‡æäº¤"
            git add public/news-data.json
            # æ£€æŸ¥ç‰ˆæœ¬æ–‡ä»¶æ˜¯å¦ä¹Ÿæœ‰å˜åŒ–
            if git diff --quiet public/version.json; then
              echo "ç‰ˆæœ¬æ–‡ä»¶æ— å˜åŒ–"
            else
              echo "ç‰ˆæœ¬æ–‡ä»¶æœ‰å˜åŒ–ï¼Œä¸€å¹¶æäº¤"
              git add public/version.json
            fi
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°AIæ–°é—»æ•°æ® - $(date +'%Y-%m-%d %H:%M:%S UTC')"
            
            # å°è¯•æ¨é€ï¼Œå¦‚æœå¤±è´¥åˆ™é‡è¯•
            for i in {1..3}; do
              if git push origin main; then
                echo "æ¨é€æˆåŠŸ"
                break
              else
                echo "æ¨é€å¤±è´¥ï¼Œå°è¯•ç¬¬ $i æ¬¡é‡è¯•"
                git pull --rebase origin main
                sleep 5
              fi
            done
          fi