name: Auto Blog Generation

on:
  schedule:
    # æ¯å¤© UTC 1:00 å’Œ 7:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 9:00 å’Œ 15:00ï¼‰
    - cron: '0 1,7 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      articles_count:
        description: 'ç”Ÿæˆæ–‡ç« æ•°é‡'
        required: false
        default: '2'
        type: string

permissions:
  contents: write
  actions: read
  checks: write
  pull-requests: write

jobs:
  generate-blog:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Check for news data
      run: |
        if [ ! -f public/news-data.json ]; then
          echo "âš ï¸ æ–°é—»æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡åšå®¢ç”Ÿæˆ"
          exit 0
        fi
        
    - name: Generate blog articles
      run: npm run auto-blog
      env:
        DAILY_ARTICLES: ${{ github.event.inputs.articles_count || '2' }}
        
    - name: Generate static HTML for SEO
      run: npm run generate-static-blog
        
    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
        else
          echo "changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        git add public/blog-data.json
        git add public/blog/
        git commit -m "ğŸ¤– è‡ªåŠ¨ç”Ÿæˆåšå®¢æ–‡ç« å’Œé™æ€HTML $(date +%Y-%m-%d-%H:%M)"
        git push
        
    # é¿å…é‡å¤è§¦å‘éƒ¨ç½²ï¼špush åˆ° main å·²ä¼šè§¦å‘ deploy.ymlï¼Œè¿™é‡Œä¸å†é¢å¤– dispatch
    # - name: Trigger deployment
    #   if: steps.verify-changed-files.outputs.changes == 'true'
    #   uses: actions/github-script@v7
    #   with:
    #     script: |
    #       github.rest.actions.createWorkflowDispatch({
    #         owner: context.repo.owner,
    #         repo: context.repo.repo,
    #         workflow_id: 'deploy.yml',
    #         ref: 'main'
    #       })
          
    - name: Create summary
      if: always()
      run: |
        echo "## ğŸ¤– è‡ªåŠ¨åšå®¢ç”ŸæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "- **æ‰§è¡Œæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›®æ ‡æ–‡ç« æ•°**: ${{ github.event.inputs.articles_count || '2' }}" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.verify-changed-files.outputs.changes }}" == "true" ]; then
          echo "- **ç”ŸæˆçŠ¶æ€**: âœ… æˆåŠŸç”Ÿæˆæ–°æ–‡ç« " >> $GITHUB_STEP_SUMMARY
          echo "- **å˜æ›´æ–‡ä»¶**: blog-data.json" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **ç”ŸæˆçŠ¶æ€**: â„¹ï¸ æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ–°é—»ï¼Œæœªç”Ÿæˆæ–°æ–‡ç« " >> $GITHUB_STEP_SUMMARY
        fi
        
  notify:
    needs: generate-blog
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: Notify on failure
      run: |
        echo "âš ï¸ è‡ªåŠ¨åšå®¢ç”Ÿæˆä»»åŠ¡å¤±è´¥"
        echo "è¯·æ£€æŸ¥æ—¥å¿—å¹¶æ‰‹åŠ¨å¤„ç†"
