var e=Object.defineProperty;const t=class e{constructor(){}static getInstance(){return e.instance||(e.instance=new e),e.instance}isWeChatEnvironment(){return/micromessenger/i.test(navigator.userAgent)}async configureShare(e){if(!this.isWeChatEnvironment())return;document.title=e.title;const t=await this.validateAndOptimizeImage(e.imgUrl),a={...e,imgUrl:t},i=this.createWeChatShareProxyUrl(a),s={...a,link:i};this.setupPageMeta(s),this.setupStructuredData(s),this.tryBasicJSSDK(s).catch(e=>{}),this.forceRefreshCache()}setupPageMeta(e){this.removeOldMetaTags();const t=e.imgUrl;this.setMetaTag("name","description",e.desc),this.setMetaTag("name","keywords",this.generateKeywords(e.title)),this.setMetaTag("property","og:type","article"),this.setMetaTag("property","og:title",e.title),this.setMetaTag("property","og:description",e.desc),this.setMetaTag("property","og:url",e.link),this.setMetaTag("property","og:site_name","AI推"),this.setMetaTag("property","og:locale","zh_CN"),this.setMetaTag("property","og:image",t),this.setMetaTag("property","og:image:secure_url",t),this.setMetaTag("property","og:image:url",t),this.setMetaTag("property","og:image:width","300"),this.setMetaTag("property","og:image:height","300"),this.setMetaTag("property","og:image:type","image/png"),this.setMetaTag("property","og:image:alt",e.title),this.setMetaTag("name","wechat:title",e.title),this.setMetaTag("name","wechat:desc",e.desc),this.setMetaTag("name","wechat:image",t),this.setMetaTag("name","wxcard:title",e.title),this.setMetaTag("name","wxcard:desc",e.desc),this.setMetaTag("name","wxcard:imgUrl",t),this.setMetaTag("name","wxcard:link",e.link),this.setMetaTag("name","weixin:title",e.title),this.setMetaTag("name","weixin:desc",e.desc),this.setMetaTag("name","weixin:imgUrl",t),this.setMetaTag("itemprop","name",e.title),this.setMetaTag("itemprop","description",e.desc),this.setMetaTag("itemprop","image",t),this.setMetaTag("itemprop","url",e.link),this.setMetaTag("name","twitter:card","summary_large_image"),this.setMetaTag("name","twitter:site","@aipush_news"),this.setMetaTag("name","twitter:title",e.title),this.setMetaTag("name","twitter:description",e.desc),this.setMetaTag("name","twitter:image",t),this.setMetaTag("name","format-detection","telephone=no"),this.setMetaTag("name","x5-orientation","portrait"),this.setMetaTag("name","x5-fullscreen","true"),this.setMetaTag("name","mobile-web-app-capable","yes")}async tryBasicJSSDK(e){if(void 0===window.wx)return;const t=window.wx;try{t.config({debug:!1,appId:"wx9334c03d16a456a1",timestamp:Math.floor(Date.now()/1e3),nonceStr:this.generateNonceStr(),signature:"invalid_signature_for_personal_account",jsApiList:["onMenuShareAppMessage","onMenuShareTimeline","updateAppMessageShareData","updateTimelineShareData"]}),t.ready(()=>{this.setupBasicShare(e)}),t.error(e=>{})}catch(a){}}setupBasicShare(e){const t=window.wx,a=this.optimizeImageUrl(e.imgUrl),i={title:e.title,desc:e.desc,link:e.link,imgUrl:a,success:()=>{},cancel:()=>{}};try{t.updateAppMessageShareData&&t.updateAppMessageShareData(i),t.updateTimelineShareData&&t.updateTimelineShareData({title:i.title,link:i.link,imgUrl:i.imgUrl}),t.onMenuShareAppMessage&&t.onMenuShareAppMessage(i),t.onMenuShareTimeline&&t.onMenuShareTimeline({title:i.title,link:i.link,imgUrl:i.imgUrl})}catch(s){}}setupStructuredData(e){const t=document.createElement("script");t.type="application/ld+json",t.textContent=JSON.stringify({"@context":"https://schema.org","@type":"NewsArticle",headline:e.title,description:e.desc,url:e.link,image:[this.optimizeImageUrl(e.imgUrl)],datePublished:(new Date).toISOString(),author:{"@type":"Organization",name:"AI推"},publisher:{"@type":"Organization",name:"AI推",url:"https://news.aipush.fun",logo:{"@type":"ImageObject",url:"https://news.aipush.fun/favicon.svg"}}});const a=document.querySelector('script[type="application/ld+json"]');a&&a.remove(),document.head.appendChild(t)}setMetaTag(e,t,a){let i=document.querySelector(`meta[${e}="${t}"]`);i||(i=document.createElement("meta"),i.setAttribute(e,t),document.head.appendChild(i)),i.setAttribute("content",a)}getAllMetaTags(){const e={};return document.querySelectorAll('meta[property^="og:"], meta[name^="twitter:"], meta[name^="wechat:"], meta[name^="wxcard:"], meta[itemprop]').forEach(t=>{const a=t.getAttribute("property")||t.getAttribute("name")||t.getAttribute("itemprop"),i=t.getAttribute("content");a&&i&&(e[a]=i)}),e}removeOldMetaTags(){['meta[property^="og:"]','meta[name^="twitter:"]','meta[name^="wechat:"]','meta[itemprop="name"]','meta[itemprop="description"]','meta[itemprop="image"]','meta[name="description"]','meta[name="keywords"]'].forEach(e=>{document.querySelectorAll(e).forEach(e=>e.remove())})}optimizeImageUrl(e){const t="https://news.aipush.fun/wechat-share-300.png";return e?(e.startsWith("http://")&&(e=e.replace("http://","https://")),e.startsWith("/")&&(e=`https://news.aipush.fun${e}`),(e=e.split("?")[0]).includes("news.aipush.fun")||e.includes("placeholder")||e.includes("wechat-share")||e.includes("cat-share")||!e.includes("http")||e.endsWith(".svg")?t:e):t}async validateAndOptimizeImage(e){const t=this.optimizeImageUrl(e);try{await fetch(t,{method:"HEAD",mode:"no-cors"});return t}catch(a){return"https://news.aipush.fun/wechat-share-300.png"}}forceRefreshCache(){const e=new URL(window.location.href);e.searchParams.set("_wechat_refresh",Date.now().toString()),window.history.replaceState({},"",e.toString()),this.setMetaTag("http-equiv","Cache-Control","no-cache, no-store, must-revalidate, max-age=0"),this.setMetaTag("http-equiv","Pragma","no-cache"),this.setMetaTag("http-equiv","Expires","0")}getMetaTagCount(){return document.querySelectorAll('meta[property^="og:"], meta[name^="twitter:"], meta[name^="wechat:"], meta[name^="wxcard:"]').length}createWeChatShareProxyUrl(e){const t=this.extractNewsIdFromUrl(e.link);if(!t)return e.link;const a=new URL("/wechat-share-proxy.html","https://news.aipush.fun");return a.searchParams.set("id",t),a.searchParams.set("title",e.title),a.searchParams.set("desc",e.desc),a.searchParams.set("image",e.imgUrl),a.searchParams.set("url",e.link),a.searchParams.set("t",Date.now().toString()),a.toString()}extractNewsIdFromUrl(e){const t=[/#\/news\/([^\/\?&]+)/,/\/news\/([^\/\?&]+)/,/newsId=([^&]+)/,/id=([^&]+)/];for(const a of t){const t=e.match(a);if(t&&t[1])return t[1]}return null}generateKeywords(e){const t=e.split(/[，。！？\s]+/).slice(0,3);return["AI","人工智能","新闻","资讯","科技"].concat(t).join(",")}generateNonceStr(){return Math.random().toString(36).substring(2,17)}showShareTip(){if(!this.isWeChatEnvironment())return;const e=document.createElement("div");e.style.cssText="\n      position: fixed;\n      top: 20px;\n      left: 50%;\n      transform: translateX(-50%);\n      background: rgba(0,0,0,0.8);\n      color: white;\n      padding: 12px 20px;\n      border-radius: 6px;\n      font-size: 14px;\n      z-index: 10000;\n      animation: fadeInOut 3s ease;\n    ",e.innerHTML='点击右上角 "..." 可以分享到朋友圈';const t=document.createElement("style");t.textContent="\n      @keyframes fadeInOut {\n        0%, 100% { opacity: 0; }\n        10%, 90% { opacity: 1; }\n      }\n    ",document.head.appendChild(t),document.body.appendChild(e),setTimeout(()=>{e.remove(),t.remove()},3e3)}};var a,i;((t,a,i)=>{a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[a]=i})(t,"symbol"!=typeof(a="instance")?a+"":a,i);const s=t.getInstance();export{s as p};
