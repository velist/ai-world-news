var t=Object.defineProperty,e=(e,i,s)=>((e,i,s)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s)(e,"symbol"!=typeof i?i+"":i,s);const i=class t{constructor(){e(this,"canvas"),e(this,"ctx"),e(this,"defaultConfig",{width:750,height:1334,backgroundColor:"#ffffff",brandColor:"#007AFF",textColor:"#1D1D1F",accentColor:"#FF3B30"}),e(this,"appleColors",{blue:"#007AFF",green:"#34C759",orange:"#FF9500",red:"#FF3B30",purple:"#AF52DE",pink:"#FF2D92",yellow:"#FFCC00",teal:"#5AC8FA",indigo:"#5856D6",gray:"#8E8E93",darkGray:"#1D1D1F",lightGray:"#F2F2F7"}),this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")}static getInstance(){return t.instance||(t.instance=new t),t.instance}async generateNewsPoster(t){const e=this.defaultConfig,i=2*e.width,s=2*e.height;this.canvas.width=i,this.canvas.height=s,this.canvas.style.width=`${e.width}px`,this.canvas.style.height=`${e.height}px`,this.ctx.scale(2,2),this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="high",this.ctx.textRenderingOptimization="optimizeQuality",this.ctx.fillStyle=e.backgroundColor,this.ctx.fillRect(0,0,e.width,e.height);try{await this.drawBackground(),await this.drawBrandHeader(),await this.drawNewsImage(t.imageUrl),await this.drawContentArea(t),await this.drawBottomArea(t.id);return this.canvas.toDataURL("image/png")}catch(a){throw new Error("海报生成失败")}}async drawBackground(){const t=this.ctx.createLinearGradient(0,0,0,this.canvas.height);t.addColorStop(0,this.appleColors.lightGray),t.addColorStop(.5,"#ffffff"),t.addColorStop(1,this.appleColors.lightGray),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}async drawBrandHeader(){const t=.15*this.canvas.height,e=this.ctx.createLinearGradient(0,0,this.canvas.width,0);e.addColorStop(0,this.appleColors.blue),e.addColorStop(.5,this.appleColors.purple),e.addColorStop(1,this.appleColors.pink),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,this.canvas.width,t),this.ctx.save(),this.ctx.globalCompositeOperation="destination-out",this.ctx.fillStyle="#000000",this.ctx.beginPath(),this.ctx.arc(0,0,20,0,Math.PI/2),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(this.canvas.width,0,20,Math.PI/2,Math.PI),this.ctx.fill(),this.ctx.restore();const i=this.canvas.width/2,s=t/2;this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.ctx.beginPath(),this.ctx.arc(i,s,30,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#ffffff",this.ctx.font='bold 36px -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif',this.ctx.textAlign="center",this.ctx.fillText("AI推",i,s+8),this.ctx.font='16px -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif',this.ctx.fillStyle="rgba(255, 255, 255, 0.9)",this.ctx.fillText("智能新闻推送",i,s+45)}async drawNewsImage(t){const e=.15*this.canvas.height,i=.45*this.canvas.height,s=this.canvas.width,a=[];t&&(a.push(t),t.startsWith("http")||a.push(`https://news.aipush.fun${t}`)),a.push("/wechat-share-300.png"),a.push("https://news.aipush.fun/wechat-share-300.png");let n=!1;for(const r of a)try{const t=await this.loadImage(r);this.ctx.fillStyle=this.appleColors.lightGray,this.ctx.fillRect(0,e,s,i);const a=Math.max(s/t.width,i/t.height),h=t.width*a,l=t.height*a,o=(s-h)/2,c=(i-l)/2;this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(0,e,s,i),this.ctx.clip(),this.ctx.drawImage(t,0+o,e+c,h,l),this.ctx.restore();const d=this.ctx.createLinearGradient(0,e+i-100,0,e+i);d.addColorStop(0,"rgba(0, 0, 0, 0)"),d.addColorStop(1,"rgba(0, 0, 0, 0.3)"),this.ctx.fillStyle=d,this.ctx.fillRect(0,e,s,i),n=!0;break}catch(h){continue}n||await this.drawImagePlaceholder()}async drawImagePlaceholder(){const t=.15*this.canvas.height,e=.45*this.canvas.height,i=this.canvas.width,s=this.ctx.createLinearGradient(0,t,i,t+e);s.addColorStop(0,"#667eea"),s.addColorStop(.5,"#764ba2"),s.addColorStop(1,"#f093fb"),this.ctx.fillStyle=s,this.ctx.fillRect(0,t,i,e),this.ctx.fillStyle="rgba(255, 255, 255, 0.1)",this.ctx.beginPath(),this.ctx.arc(.8*i,t+.3*e,80,0,2*Math.PI),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(.2*i,t+.7*e,40,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="rgba(255, 255, 255, 0.9)",this.ctx.font='bold 48px -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif',this.ctx.textAlign="center",this.ctx.fillText("AI推",this.canvas.width/2,t+e/2-10),this.ctx.font='20px -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif',this.ctx.fillStyle="rgba(255, 255, 255, 0.8)",this.ctx.fillText("智能新闻推送",this.canvas.width/2,t+e/2+30);const a=this.ctx.createLinearGradient(0,t+e-100,0,t+e);a.addColorStop(0,"rgba(0, 0, 0, 0)"),a.addColorStop(1,"rgba(0, 0, 0, 0.3)"),this.ctx.fillStyle=a,this.ctx.fillRect(0,t,i,e)}async drawContentArea(t){const e=.15*this.canvas.height+.45*this.canvas.height,i=.25*this.canvas.height;this.ctx.fillStyle="#ffffff",this.ctx.fillRect(0,e,this.canvas.width,i);const s=e+50;this.ctx.fillStyle=this.appleColors.darkGray,this.ctx.font='bold 42px -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif',this.ctx.textAlign="left";const a=this.canvas.width-60,n=this.wrapText(t.title,a,42);n.slice(0,2).forEach((t,e)=>{this.ctx.fillText(t,30,s+52*e)});const h=s+52*Math.min(n.length,2)+30;this.ctx.fillStyle=this.appleColors.gray,this.ctx.font='28px -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif';const r=t.summary.length>100?t.summary.substring(0,100)+"...":t.summary;this.wrapText(r,a,28).slice(0,2).forEach((t,e)=>{this.ctx.fillText(t,30,h+38*e)});const l=e+i-40;this.ctx.fillStyle=this.appleColors.blue,this.ctx.font='22px -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif';const o=new Date(t.publishedAt).toLocaleDateString("zh-CN"),c=`${t.source} • ${t.category} • ${o}`;this.ctx.fillText(c,30,l)}async drawBottomArea(t){const e=.85*this.canvas.height,i=.15*this.canvas.height,s=30;this.ctx.fillStyle=this.appleColors.lightGray,this.ctx.fillRect(0,e,this.canvas.width,i);const a=this.canvas.width-140-s,n=e+(i-140)/2;await this.drawRealQRCode(a,n,140,t),this.ctx.fillStyle=this.appleColors.darkGray,this.ctx.font='bold 28px -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif',this.ctx.textAlign="left",this.ctx.fillText("扫码阅读完整新闻",s,e+50),this.ctx.font='24px -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif',this.ctx.fillStyle=this.appleColors.blue,this.ctx.fillText("news.aipush.fun",s,e+85),this.ctx.fillStyle=this.appleColors.orange,this.ctx.beginPath(),this.ctx.arc(230,e+45,3,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle=this.appleColors.green,this.ctx.beginPath(),this.ctx.arc(250,e+35,2,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle=this.appleColors.pink,this.ctx.beginPath(),this.ctx.arc(270,e+55,2.5,0,2*Math.PI),this.ctx.fill()}async drawRealQRCode(t,e,i,s){try{const n=`${"https://news.aipush.fun"}/#/news/${s}`,h=[{url:`https://api.qrserver.com/v1/create-qr-code/?size=${i}x${i}&data=${encodeURIComponent(n)}&format=png&margin=1&ecc=H&color=000000&bgcolor=ffffff`,name:"QRServer"},{url:`https://quickchart.io/qr?text=${encodeURIComponent(n)}&size=${i}&margin=1&format=png&ecLevel=H`,name:"QuickChart"},{url:`https://qr.liantu.com/api.php?text=${encodeURIComponent(n)}&m=1&e=H&p=1&w=${i}&h=${i}`,name:"联图"},{url:`https://chart.googleapis.com/chart?chs=${i}x${i}&cht=qr&chl=${encodeURIComponent(n)}&choe=UTF-8&chld=H|1`,name:"Google Charts"}];for(const s of h)try{const a=new Image;a.crossOrigin="anonymous";if(await new Promise((n,h)=>{const r=setTimeout(()=>{h(new Error("二维码加载超时"))},8e3);a.onload=()=>{clearTimeout(r),a.width<50||a.height<50?h(new Error("二维码图片尺寸异常")):(this.ctx.fillStyle="#ffffff",this.ctx.fillRect(t-12,e-12,i+24,i+24),this.ctx.imageSmoothingEnabled=!1,this.ctx.drawImage(a,t,e,i,i),this.ctx.strokeStyle="#333333",this.ctx.lineWidth=3,this.ctx.strokeRect(t-6,e-6,i+12,i+12),this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=1,this.ctx.strokeRect(t-1,e-1,i+2,i+2),n(!0))},a.onerror=t=>{clearTimeout(r),h(new Error(`${s.name}图片加载失败: ${t}`))},a.src=s.url}))return}catch(a){continue}this.drawHighQualityQRCodePlaceholder(t,e,i,n)}catch(a){this.drawHighQualityQRCodePlaceholder(t,e,i,`https://news.aipush.fun/#/news/${s}`)}}drawHighQualityQRCodePlaceholder(t,e,i,s){this.ctx.fillStyle="#ffffff",this.ctx.fillRect(t-12,e-12,i+24,i+24),this.ctx.fillStyle="#000000";const a=i/29,n=this.generateHighQualityQRPattern();this.ctx.imageSmoothingEnabled=!1;for(let r=0;r<29;r++)for(let i=0;i<29;i++)n[r]&&n[r][i]&&this.ctx.fillRect(Math.floor(t+i*a),Math.floor(e+r*a),Math.ceil(a),Math.ceil(a));this.ctx.strokeStyle="#333333",this.ctx.lineWidth=3,this.ctx.strokeRect(t-6,e-6,i+12,i+12),this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=1,this.ctx.strokeRect(t-1,e-1,i+2,i+2),this.ctx.fillStyle="#666666",this.ctx.font='10px -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif',this.ctx.textAlign="center",this.ctx.fillText("扫码访问新闻",t+i/2,e+i+28);const h=s.length>30?s.substring(0,27)+"...":s;this.ctx.fillStyle="#999999",this.ctx.font='8px -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif',this.ctx.fillText(h,t+i/2,e+i+40)}generateHighQualityQRPattern(){const t=Array(29).fill(0).map(()=>Array(29).fill(0));this.drawQRFinderPattern(t,0,0),this.drawQRFinderPattern(t,0,21),this.drawQRFinderPattern(t,21,0);for(let e=8;e<21;e++)t[6][e]=e%2,t[e][6]=e%2;return this.drawAlignmentPattern(t,22,22),this.drawFormatInformation(t),this.fillDataArea(t),t}drawQRFinderPattern(t,e,i){for(let s=0;s<7;s++)for(let a=0;a<7;a++){const n=e+s,h=i+a;n<29&&h<29&&(t[n][h]=0===s||6===s||0===a||6===a?1:1===s||5===s||1===a||5===a?0:1)}for(let s=0;s<8;s++)e+7<29&&i+s<29&&(t[e+7][i+s]=0),i+7<29&&e+s<29&&(t[e+s][i+7]=0)}drawAlignmentPattern(t,e,i){for(let s=-2;s<=2;s++)for(let a=-2;a<=2;a++){const n=e+s,h=i+a;n>=0&&n<29&&h>=0&&h<29&&(2===Math.abs(s)||2===Math.abs(a)||0===s&&0===a?t[n][h]=1:t[n][h]=0)}}drawFormatInformation(t){const e=[1,0,1,0,1,0,0,0,0,1,1,1,0,1,0];for(let i=0;i<6;i++)t[8][i]=e[i];t[8][7]=e[6],t[8][8]=e[7];for(let i=7;i<15;i++)t[8][14+i]=e[i];for(let i=0;i<8;i++)t[28-i][8]=e[i];for(let i=8;i<15;i++)t[15-i][8]=e[i]}fillDataArea(t){for(let e=0;e<29;e++)for(let i=0;i<29;i++)if(0===t[e][i]&&!this.isReservedPosition(e,i)){const s=(31*e+17*i+13*(e+i))%7;t[e][i]=s<3?1:0}}isReservedPosition(t,e){return t<9&&e<9||t<9&&e>19||t>19&&e<9||(6===t||6===e||(Math.abs(t-22)<=2&&Math.abs(e-22)<=2||(8===t&&(e<9||e>19)||8===e&&(t<9||t>19))))}generateEnhancedQRPattern(){const t=Array(25).fill(0).map(()=>Array(25).fill(0));this.drawEnhancedFinderPattern(t,0,0),this.drawEnhancedFinderPattern(t,0,17),this.drawEnhancedFinderPattern(t,17,0);for(let i=8;i<17;i++)t[6][i]=i%2,t[i][6]=i%2;const e=this.generateDataPattern(25);for(let i=0;i<25;i++)for(let s=0;s<25;s++)0!==t[i][s]||this.isEnhancedReservedArea(i,s)||(t[i][s]=e[i][s]);return t}drawEnhancedFinderPattern(t,e,i){for(let s=0;s<7;s++)for(let a=0;a<7;a++){const n=e+s,h=i+a;n<25&&h<25&&(0===s||6===s||0===a||6===a||s>=2&&s<=4&&a>=2&&a<=4)&&(t[n][h]=1)}}generateDataPattern(t){const e=Array(t).fill(0).map(()=>Array(t).fill(0));for(let i=0;i<t;i++)for(let s=0;s<t;s++){const t=(31*i+17*s+i*s*7)%3;e[i][s]=0===t?1:0}return e}isEnhancedReservedArea(t,e){return t<9&&e<9||t<9&&e>15||t>15&&e<9||(6===t||6===e)}wrapText(t,e,i){const s=t.split(""),a=[];let n="";for(const h of s){const t=n+h;this.ctx.measureText(t).width>e&&""!==n?(a.push(n),n=h):n=t}return n&&a.push(n),a}loadImage(t){return new Promise((e,i)=>{const s=new Image;s.crossOrigin="anonymous",s.onload=()=>e(s),s.onerror=i,s.src=t})}downloadPoster(t,e="news-poster.png"){const i=document.createElement("a");i.download=e,i.href=t,document.body.appendChild(i),i.click(),document.body.removeChild(i)}async shareToWeChat(t){try{const e=await fetch(t),i=await e.blob();if(navigator.share&&navigator.canShare&&navigator.canShare({files:[new File([i],"poster.png",{type:"image/png"})]})){const t=new File([i],"news-poster.png",{type:"image/png"});await navigator.share({title:"来自AI推的新闻分享",files:[t]})}else this.showShareTip(t)}catch(e){this.showShareTip(t)}}showShareTip(t){const e=document.createElement("div");e.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0,0,0,0.8);\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      z-index: 10000;\n    ";const i=document.createElement("div");i.style.cssText="\n      background: white;\n      padding: 20px;\n      border-radius: 10px;\n      max-width: 90%;\n      max-height: 90%;\n      text-align: center;\n      overflow: auto;\n    ";const s=document.createElement("img");s.src=t,s.style.cssText="\n      max-width: 100%;\n      height: auto;\n      margin-bottom: 20px;\n    ";const a=document.createElement("p");a.textContent="长按图片保存，然后在微信中发送图片即可分享",a.style.cssText="\n      margin: 10px 0;\n      color: #666;\n    ";const n=document.createElement("button");n.textContent="关闭",n.style.cssText="\n      padding: 10px 20px;\n      background: #3498db;\n      color: white;\n      border: none;\n      border-radius: 5px;\n      cursor: pointer;\n    ",n.onclick=()=>document.body.removeChild(e),i.appendChild(s),i.appendChild(a),i.appendChild(n),e.appendChild(i),document.body.appendChild(e)}};e(i,"instance");let s=i;const a=s.getInstance();export{s as PosterShareService,a as posterShareService};
