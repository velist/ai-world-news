<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模板修复测试 - 验证真实模板背景</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .preview-area {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }
        .controls {
            flex: 1;
            min-width: 300px;
        }
        .preview {
            flex: 1;
            text-align: center;
        }
        button {
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            margin: 10px 0;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        .success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
        }
        .error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
        }
        .info {
            background: linear-gradient(135deg, #cce7ff 0%, #b3d9ff 100%);
            color: #0c5460;
        }
        .preview img {
            max-width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .debug-log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <h1 style="color: white; text-align: center; margin-bottom: 30px;">🛠️ 模板修复测试 - 验证真实模板背景</h1>
    
    <div class="test-container">
        <div class="preview-area">
            <div class="controls">
                <h3>测试说明</h3>
                <div class="info">
                    <strong>✅ 修复内容：</strong><br>
                    1. 优化模板图片加载逻辑<br>
                    2. 支持多个模板路径尝试<br>
                    3. 添加用户期望的模板图片<br>
                    4. 改进错误处理和调试信息
                </div>
                
                <button onclick="testTemplateLoad()" id="testBtn">🔍 测试模板加载</button>
                <button onclick="generateWithTemplate()" id="generateBtn">🎨 生成分享图</button>
                <button onclick="clearLog()" style="background: #6c757d;">🧹 清空日志</button>
                
                <div id="status"></div>
                <div id="debugLog" class="debug-log"></div>
            </div>
            
            <div class="preview">
                <h3>预览效果</h3>
                <div id="previewArea">
                    <p style="color: #999; padding: 60px 20px; background: #f8f9fa; border-radius: 12px; border: 2px dashed #dee2e6;">
                        点击测试按钮查看效果
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let debugMessages = [];

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugMessages.push(`[${timestamp}] ${message}`);
            updateDebugLog();
            console.log(message);
        }

        function updateDebugLog() {
            const logElement = document.getElementById('debugLog');
            logElement.innerHTML = debugMessages.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            debugMessages = [];
            updateDebugLog();
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = `<div class="${type}">${message}</div>`;
        }

        async function testTemplateLoad() {
            log('🚀 开始模板加载测试...');
            updateStatus('⏳ 正在测试模板图片加载...', 'info');
            
            const templateUrls = [
                './share-template-blank.jpg',     // 原始路径
                '/share-template-blank.jpg',      // 绝对路径
                './新闻图分享示意-空白.jpg',         // 用户期望的模板名称
                '/新闻图分享示意-空白.jpg'          // 用户期望的模板绝对路径
            ];
            
            let successCount = 0;
            let failCount = 0;
            
            for (const url of templateUrls) {
                try {
                    log(`📡 测试路径: ${url}`);
                    const img = await loadImageTest(url);
                    log(`✅ 成功! 尺寸: ${img.width} × ${img.height}`);
                    successCount++;
                    
                    // 显示成功加载的第一张图片
                    if (successCount === 1) {
                        document.getElementById('previewArea').innerHTML = 
                            `<img src="${url}" alt="加载成功的模板图片" style="max-width: 300px;">
                             <p>✅ 模板图片加载成功！</p>`;
                    }
                } catch (error) {
                    log(`❌ 失败: ${error.message}`);
                    failCount++;
                }
            }
            
            if (successCount > 0) {
                updateStatus(`✅ 测试完成！成功 ${successCount} 个，失败 ${failCount} 个`, 'success');
            } else {
                updateStatus('❌ 所有模板路径都加载失败！', 'error');
                document.getElementById('previewArea').innerHTML = 
                    '<p style="color: #dc3545;">❌ 所有模板图片路径都无法访问</p>';
            }
        }

        function loadImageTest(src, timeout = 5000) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                const timer = setTimeout(() => {
                    reject(new Error('加载超时'));
                }, timeout);
                
                img.onload = () => {
                    clearTimeout(timer);
                    resolve(img);
                };
                
                img.onerror = () => {
                    clearTimeout(timer);
                    reject(new Error('加载失败'));
                };
                
                img.src = src;
            });
        }

        // 简化的分享图生成测试
        class SimpleTemplateTest {
            constructor() {
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
            }

            async generateWithTemplate() {
                this.canvas.width = 800;
                this.canvas.height = 1200;
                this.ctx.imageSmoothingEnabled = true;
                this.ctx.imageSmoothingQuality = 'high';

                log('🎨 开始生成分享图...');

                try {
                    // 尝试加载真实模板
                    await this.loadRealTemplate();
                    
                    // 叠加标题
                    this.overlayTitle('模板修复测试成功！');
                    
                    // 叠加内容
                    this.overlayContent('这是使用真实模板图片生成的分享图。现在可以看到精美的蓝色渐变背景、白色卡片区域和底部的品牌元素。');
                    
                    return this.canvas.toDataURL('image/jpeg', 0.9);
                } catch (error) {
                    log(`❌ 生成失败: ${error.message}`);
                    throw error;
                }
            }

            async loadRealTemplate() {
                const templateUrls = [
                    './新闻图分享示意-空白.jpg',
                    './share-template-blank.jpg',
                    '/新闻图分享示意-空白.jpg',
                    '/share-template-blank.jpg'
                ];
                
                for (const url of templateUrls) {
                    try {
                        log(`🔍 尝试加载模板: ${url}`);
                        const templateImg = await loadImageTest(url, 8000);
                        
                        // 绘制模板背景
                        this.ctx.drawImage(templateImg, 0, 0, this.canvas.width, this.canvas.height);
                        log(`✅ 模板背景绘制成功: ${url}`);
                        return;
                    } catch (error) {
                        log(`⚠️ 模板加载失败 [${url}]: ${error.message}`);
                        continue;
                    }
                }
                
                throw new Error('所有模板路径都加载失败');
            }

            overlayTitle(title) {
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = 'bold 72px "Microsoft YaHei", sans-serif';
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                
                // 在蓝色标题区域绘制
                this.ctx.fillText(title, this.canvas.width / 2, 150);
                log('📝 标题叠加完成');
            }

            overlayContent(content) {
                this.ctx.fillStyle = '#333333';
                this.ctx.font = '32px "Microsoft YaHei", sans-serif';
                this.ctx.textAlign = 'center';
                
                // 简单的文字换行
                const maxWidth = 640;
                const lines = this.wrapText(content, maxWidth);
                const startY = 300;
                
                lines.forEach((line, index) => {
                    this.ctx.fillText(line, this.canvas.width / 2, startY + index * 40);
                });
                
                log('📄 内容叠加完成');
            }

            wrapText(text, maxWidth) {
                const characters = text.split('');
                const lines = [];
                let currentLine = '';

                for (const char of characters) {
                    const testLine = currentLine + char;
                    const metrics = this.ctx.measureText(testLine);
                    
                    if (metrics.width > maxWidth && currentLine !== '') {
                        lines.push(currentLine);
                        currentLine = char;
                    } else {
                        currentLine = testLine;
                    }
                }
                
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                return lines;
            }
        }

        const templateTest = new SimpleTemplateTest();

        async function generateWithTemplate() {
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = '⏳ 生成中...';
            
            try {
                log('🎨 开始生成测试分享图...');
                updateStatus('⏳ 正在使用真实模板生成分享图...', 'info');
                
                const imageData = await templateTest.generateWithTemplate();
                
                document.getElementById('previewArea').innerHTML = `
                    <img src="${imageData}" alt="生成的分享图" style="max-width: 400px;">
                    <p>✅ 使用真实模板生成成功！</p>
                    <button onclick="downloadImage('${imageData}')" style="margin-top: 10px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        💾 下载图片
                    </button>
                `;
                
                updateStatus('✅ 分享图生成成功！现在使用的是真实的模板背景', 'success');
                log('🎉 生成完成！');
                
            } catch (error) {
                updateStatus(`❌ 生成失败: ${error.message}`, 'error');
                log(`❌ 生成过程出错: ${error.message}`);
            }
            
            generateBtn.disabled = false;
            generateBtn.textContent = '🎨 生成分享图';
        }

        function downloadImage(dataUrl) {
            const link = document.createElement('a');
            link.download = 'template-fix-test.jpg';
            link.href = dataUrl;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>