<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡æ¿ä¿®å¤æµ‹è¯• - éªŒè¯çœŸå®æ¨¡æ¿èƒŒæ™¯</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .preview-area {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }
        .controls {
            flex: 1;
            min-width: 300px;
        }
        .preview {
            flex: 1;
            text-align: center;
        }
        button {
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            margin: 10px 0;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        .success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
        }
        .error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
        }
        .info {
            background: linear-gradient(135deg, #cce7ff 0%, #b3d9ff 100%);
            color: #0c5460;
        }
        .preview img {
            max-width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .debug-log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <h1 style="color: white; text-align: center; margin-bottom: 30px;">ğŸ› ï¸ æ¨¡æ¿ä¿®å¤æµ‹è¯• - éªŒè¯çœŸå®æ¨¡æ¿èƒŒæ™¯</h1>
    
    <div class="test-container">
        <div class="preview-area">
            <div class="controls">
                <h3>æµ‹è¯•è¯´æ˜</h3>
                <div class="info">
                    <strong>âœ… ä¿®å¤å†…å®¹ï¼š</strong><br>
                    1. ä¼˜åŒ–æ¨¡æ¿å›¾ç‰‡åŠ è½½é€»è¾‘<br>
                    2. æ”¯æŒå¤šä¸ªæ¨¡æ¿è·¯å¾„å°è¯•<br>
                    3. æ·»åŠ ç”¨æˆ·æœŸæœ›çš„æ¨¡æ¿å›¾ç‰‡<br>
                    4. æ”¹è¿›é”™è¯¯å¤„ç†å’Œè°ƒè¯•ä¿¡æ¯
                </div>
                
                <button onclick="testTemplateLoad()" id="testBtn">ğŸ” æµ‹è¯•æ¨¡æ¿åŠ è½½</button>
                <button onclick="generateWithTemplate()" id="generateBtn">ğŸ¨ ç”Ÿæˆåˆ†äº«å›¾</button>
                <button onclick="clearLog()" style="background: #6c757d;">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
                
                <div id="status"></div>
                <div id="debugLog" class="debug-log"></div>
            </div>
            
            <div class="preview">
                <h3>é¢„è§ˆæ•ˆæœ</h3>
                <div id="previewArea">
                    <p style="color: #999; padding: 60px 20px; background: #f8f9fa; border-radius: 12px; border: 2px dashed #dee2e6;">
                        ç‚¹å‡»æµ‹è¯•æŒ‰é’®æŸ¥çœ‹æ•ˆæœ
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let debugMessages = [];

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugMessages.push(`[${timestamp}] ${message}`);
            updateDebugLog();
            console.log(message);
        }

        function updateDebugLog() {
            const logElement = document.getElementById('debugLog');
            logElement.innerHTML = debugMessages.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            debugMessages = [];
            updateDebugLog();
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = `<div class="${type}">${message}</div>`;
        }

        async function testTemplateLoad() {
            log('ğŸš€ å¼€å§‹æ¨¡æ¿åŠ è½½æµ‹è¯•...');
            updateStatus('â³ æ­£åœ¨æµ‹è¯•æ¨¡æ¿å›¾ç‰‡åŠ è½½...', 'info');
            
            const templateUrls = [
                './share-template-blank.jpg',     // åŸå§‹è·¯å¾„
                '/share-template-blank.jpg',      // ç»å¯¹è·¯å¾„
                './æ–°é—»å›¾åˆ†äº«ç¤ºæ„-ç©ºç™½.jpg',         // ç”¨æˆ·æœŸæœ›çš„æ¨¡æ¿åç§°
                '/æ–°é—»å›¾åˆ†äº«ç¤ºæ„-ç©ºç™½.jpg'          // ç”¨æˆ·æœŸæœ›çš„æ¨¡æ¿ç»å¯¹è·¯å¾„
            ];
            
            let successCount = 0;
            let failCount = 0;
            
            for (const url of templateUrls) {
                try {
                    log(`ğŸ“¡ æµ‹è¯•è·¯å¾„: ${url}`);
                    const img = await loadImageTest(url);
                    log(`âœ… æˆåŠŸ! å°ºå¯¸: ${img.width} Ã— ${img.height}`);
                    successCount++;
                    
                    // æ˜¾ç¤ºæˆåŠŸåŠ è½½çš„ç¬¬ä¸€å¼ å›¾ç‰‡
                    if (successCount === 1) {
                        document.getElementById('previewArea').innerHTML = 
                            `<img src="${url}" alt="åŠ è½½æˆåŠŸçš„æ¨¡æ¿å›¾ç‰‡" style="max-width: 300px;">
                             <p>âœ… æ¨¡æ¿å›¾ç‰‡åŠ è½½æˆåŠŸï¼</p>`;
                    }
                } catch (error) {
                    log(`âŒ å¤±è´¥: ${error.message}`);
                    failCount++;
                }
            }
            
            if (successCount > 0) {
                updateStatus(`âœ… æµ‹è¯•å®Œæˆï¼æˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failCount} ä¸ª`, 'success');
            } else {
                updateStatus('âŒ æ‰€æœ‰æ¨¡æ¿è·¯å¾„éƒ½åŠ è½½å¤±è´¥ï¼', 'error');
                document.getElementById('previewArea').innerHTML = 
                    '<p style="color: #dc3545;">âŒ æ‰€æœ‰æ¨¡æ¿å›¾ç‰‡è·¯å¾„éƒ½æ— æ³•è®¿é—®</p>';
            }
        }

        function loadImageTest(src, timeout = 5000) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                const timer = setTimeout(() => {
                    reject(new Error('åŠ è½½è¶…æ—¶'));
                }, timeout);
                
                img.onload = () => {
                    clearTimeout(timer);
                    resolve(img);
                };
                
                img.onerror = () => {
                    clearTimeout(timer);
                    reject(new Error('åŠ è½½å¤±è´¥'));
                };
                
                img.src = src;
            });
        }

        // ç®€åŒ–çš„åˆ†äº«å›¾ç”Ÿæˆæµ‹è¯•
        class SimpleTemplateTest {
            constructor() {
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
            }

            async generateWithTemplate() {
                this.canvas.width = 800;
                this.canvas.height = 1200;
                this.ctx.imageSmoothingEnabled = true;
                this.ctx.imageSmoothingQuality = 'high';

                log('ğŸ¨ å¼€å§‹ç”Ÿæˆåˆ†äº«å›¾...');

                try {
                    // å°è¯•åŠ è½½çœŸå®æ¨¡æ¿
                    await this.loadRealTemplate();
                    
                    // å åŠ æ ‡é¢˜
                    this.overlayTitle('æ¨¡æ¿ä¿®å¤æµ‹è¯•æˆåŠŸï¼');
                    
                    // å åŠ å†…å®¹
                    this.overlayContent('è¿™æ˜¯ä½¿ç”¨çœŸå®æ¨¡æ¿å›¾ç‰‡ç”Ÿæˆçš„åˆ†äº«å›¾ã€‚ç°åœ¨å¯ä»¥çœ‹åˆ°ç²¾ç¾çš„è“è‰²æ¸å˜èƒŒæ™¯ã€ç™½è‰²å¡ç‰‡åŒºåŸŸå’Œåº•éƒ¨çš„å“ç‰Œå…ƒç´ ã€‚');
                    
                    return this.canvas.toDataURL('image/jpeg', 0.9);
                } catch (error) {
                    log(`âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`);
                    throw error;
                }
            }

            async loadRealTemplate() {
                const templateUrls = [
                    './æ–°é—»å›¾åˆ†äº«ç¤ºæ„-ç©ºç™½.jpg',
                    './share-template-blank.jpg',
                    '/æ–°é—»å›¾åˆ†äº«ç¤ºæ„-ç©ºç™½.jpg',
                    '/share-template-blank.jpg'
                ];
                
                for (const url of templateUrls) {
                    try {
                        log(`ğŸ” å°è¯•åŠ è½½æ¨¡æ¿: ${url}`);
                        const templateImg = await loadImageTest(url, 8000);
                        
                        // ç»˜åˆ¶æ¨¡æ¿èƒŒæ™¯
                        this.ctx.drawImage(templateImg, 0, 0, this.canvas.width, this.canvas.height);
                        log(`âœ… æ¨¡æ¿èƒŒæ™¯ç»˜åˆ¶æˆåŠŸ: ${url}`);
                        return;
                    } catch (error) {
                        log(`âš ï¸ æ¨¡æ¿åŠ è½½å¤±è´¥ [${url}]: ${error.message}`);
                        continue;
                    }
                }
                
                throw new Error('æ‰€æœ‰æ¨¡æ¿è·¯å¾„éƒ½åŠ è½½å¤±è´¥');
            }

            overlayTitle(title) {
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = 'bold 72px "Microsoft YaHei", sans-serif';
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                
                // åœ¨è“è‰²æ ‡é¢˜åŒºåŸŸç»˜åˆ¶
                this.ctx.fillText(title, this.canvas.width / 2, 150);
                log('ğŸ“ æ ‡é¢˜å åŠ å®Œæˆ');
            }

            overlayContent(content) {
                this.ctx.fillStyle = '#333333';
                this.ctx.font = '32px "Microsoft YaHei", sans-serif';
                this.ctx.textAlign = 'center';
                
                // ç®€å•çš„æ–‡å­—æ¢è¡Œ
                const maxWidth = 640;
                const lines = this.wrapText(content, maxWidth);
                const startY = 300;
                
                lines.forEach((line, index) => {
                    this.ctx.fillText(line, this.canvas.width / 2, startY + index * 40);
                });
                
                log('ğŸ“„ å†…å®¹å åŠ å®Œæˆ');
            }

            wrapText(text, maxWidth) {
                const characters = text.split('');
                const lines = [];
                let currentLine = '';

                for (const char of characters) {
                    const testLine = currentLine + char;
                    const metrics = this.ctx.measureText(testLine);
                    
                    if (metrics.width > maxWidth && currentLine !== '') {
                        lines.push(currentLine);
                        currentLine = char;
                    } else {
                        currentLine = testLine;
                    }
                }
                
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                return lines;
            }
        }

        const templateTest = new SimpleTemplateTest();

        async function generateWithTemplate() {
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'â³ ç”Ÿæˆä¸­...';
            
            try {
                log('ğŸ¨ å¼€å§‹ç”Ÿæˆæµ‹è¯•åˆ†äº«å›¾...');
                updateStatus('â³ æ­£åœ¨ä½¿ç”¨çœŸå®æ¨¡æ¿ç”Ÿæˆåˆ†äº«å›¾...', 'info');
                
                const imageData = await templateTest.generateWithTemplate();
                
                document.getElementById('previewArea').innerHTML = `
                    <img src="${imageData}" alt="ç”Ÿæˆçš„åˆ†äº«å›¾" style="max-width: 400px;">
                    <p>âœ… ä½¿ç”¨çœŸå®æ¨¡æ¿ç”ŸæˆæˆåŠŸï¼</p>
                    <button onclick="downloadImage('${imageData}')" style="margin-top: 10px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ğŸ’¾ ä¸‹è½½å›¾ç‰‡
                    </button>
                `;
                
                updateStatus('âœ… åˆ†äº«å›¾ç”ŸæˆæˆåŠŸï¼ç°åœ¨ä½¿ç”¨çš„æ˜¯çœŸå®çš„æ¨¡æ¿èƒŒæ™¯', 'success');
                log('ğŸ‰ ç”Ÿæˆå®Œæˆï¼');
                
            } catch (error) {
                updateStatus(`âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
                log(`âŒ ç”Ÿæˆè¿‡ç¨‹å‡ºé”™: ${error.message}`);
            }
            
            generateBtn.disabled = false;
            generateBtn.textContent = 'ğŸ¨ ç”Ÿæˆåˆ†äº«å›¾';
        }

        function downloadImage(dataUrl) {
            const link = document.createElement('a');
            link.download = 'template-fix-test.jpg';
            link.href = dataUrl;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>