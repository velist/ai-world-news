<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤´æ¡æ ·å¼æµ·æŠ¥ç”Ÿæˆæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .preview-area {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }
        .form-section {
            flex: 1;
            min-width: 300px;
        }
        .preview-section {
            flex: 1;
            text-align: center;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .poster-preview {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>ğŸ¯ å¤´æ¡æ ·å¼æµ·æŠ¥ç”Ÿæˆå™¨</h1>
    
    <div class="test-container">
        <div class="preview-area">
            <div class="form-section">
                <div class="form-group">
                    <label>æ–°é—»æ ‡é¢˜</label>
                    <textarea id="titleInput" placeholder="è¾“å…¥æ–°é—»æ ‡é¢˜...">OpenAIæ­£å¼å‘å¸ƒGPT-5ï¼šæ€§èƒ½å¤§å¹…æå‡ï¼Œå¤šæ¨¡æ€èƒ½åŠ›å…¨é¢å¢å¼ºï¼Œå®šä»·ç­–ç•¥å¼•å‘è¡Œä¸šå…³æ³¨</textarea>
                </div>
                
                <div class="form-group">
                    <label>æ–°é—»æ‘˜è¦</label>
                    <textarea id="summaryInput" placeholder="è¾“å…¥æ–°é—»æ‘˜è¦...">OpenAIä»Šæ—¥æ­£å¼å‘å¸ƒäº†å¤‡å—æœŸå¾…çš„GPT-5æ¨¡å‹ï¼Œç›¸æ¯”GPT-4åœ¨è¯­è¨€ç†è§£ã€æ¨ç†èƒ½åŠ›å’Œå¤šæ¨¡æ€å¤„ç†æ–¹é¢éƒ½æœ‰æ˜¾è‘—æå‡ã€‚æ–°æ¨¡å‹æ”¯æŒæ›´é•¿çš„ä¸Šä¸‹æ–‡é•¿åº¦ï¼Œæ¨ç†é€Ÿåº¦æå‡30%ï¼Œåœ¨æ•°å­¦ã€ç§‘å­¦å’Œç¼–ç¨‹ä»»åŠ¡ä¸Šè¡¨ç°å°¤ä¸ºçªå‡ºã€‚</textarea>
                </div>
                
                <div class="form-group">
                    <label>å‘å¸ƒæ—¶é—´</label>
                    <input type="datetime-local" id="dateInput" />
                </div>
                
                <div class="form-group">
                    <label>æ–°é—»æ¥æº</label>
                    <input type="text" id="sourceInput" value="AIæ¨-ä¸“æ³¨AIç§‘æŠ€æ–°é—»" placeholder="è¾“å…¥æ–°é—»æ¥æº..." />
                </div>
                
                <button onclick="generatePoster()" id="generateBtn">ğŸš€ ç”Ÿæˆå¤´æ¡æ ·å¼æµ·æŠ¥</button>
                
                <div id="status"></div>
            </div>
            
            <div class="preview-section">
                <h3>æµ·æŠ¥é¢„è§ˆ</h3>
                <div id="posterPreview">
                    <p style="color: #999; padding: 40px;">ç‚¹å‡»ç”ŸæˆæŒ‰é’®æŸ¥çœ‹æµ·æŠ¥æ•ˆæœ</p>
                </div>
                <button onclick="downloadPoster()" id="downloadBtn" style="margin-top: 15px; display: none;">ğŸ“¥ ä¸‹è½½æµ·æŠ¥</button>
            </div>
        </div>
    </div>

    <script>
        // è®¾ç½®é»˜è®¤æ—¶é—´ä¸ºå½“å‰æ—¶é—´
        document.getElementById('dateInput').value = new Date().toISOString().slice(0, 16);
        
        let currentPosterData = null;

        // å¤´æ¡é£æ ¼æµ·æŠ¥ç”ŸæˆæœåŠ¡
        class SimplePosterService {
            constructor() {
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                
                this.templateConfig = {
                    width: 750,
                    height: 1334,
                    backgroundColor: '#f5f5f5',
                    textColor: '#333333',
                    dateColor: '#666666',
                    authorColor: '#666666',
                    padding: 40,
                    qrSize: 100
                };
            }

            async generateSimplePoster(newsData) {
                const config = this.templateConfig;
                
                this.canvas.width = config.width;
                this.canvas.height = config.height;
                
                this.ctx.imageSmoothingEnabled = true;
                this.ctx.imageSmoothingQuality = 'high';
                
                try {
                    this.drawBackground();
                    this.drawDate(newsData.publishedAt);
                    this.drawTitle(newsData.title);
                    this.drawAuthor(newsData.source);
                    await this.drawQRCodeArea(newsData.id);
                    this.drawBrandLogo();
                    
                    return this.canvas.toDataURL('image/png', 1.0);
                } catch (error) {
                    throw new Error('æµ·æŠ¥ç”Ÿæˆå¤±è´¥');
                }
            }

            drawBackground() {
                const { width, height, backgroundColor } = this.templateConfig;
                this.ctx.fillStyle = backgroundColor;
                this.ctx.fillRect(0, 0, width, height);
            }

            drawDate(publishedAt) {
                const { padding, dateColor } = this.templateConfig;
                
                let dateStr = '08/10';
                if (publishedAt) {
                    const date = new Date(publishedAt);
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    dateStr = `${month}/${day}`;
                }
                
                this.ctx.fillStyle = dateColor;
                this.ctx.font = 'bold 80px -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif';
                this.ctx.textAlign = 'left';
                
                this.ctx.fillText(dateStr.split('/')[0], padding, padding + 80);
                
                this.ctx.fillStyle = '#333333';
                this.ctx.fillRect(padding, padding + 100, 80, 4);
                
                this.ctx.fillStyle = dateColor;
                this.ctx.fillText(dateStr.split('/')[1], padding, padding + 160);
            }

            drawTitle(title) {
                const { width, padding, textColor } = this.templateConfig;
                
                this.ctx.fillStyle = textColor;
                this.ctx.font = 'bold 48px "Microsoft YaHei", "PingFang SC", sans-serif';
                this.ctx.textAlign = 'left';
                
                const maxWidth = width - padding * 2;
                const lines = this.wrapText(title, maxWidth);
                
                const startY = 350;
                lines.slice(0, 4).forEach((line, index) => {
                    this.ctx.fillText(line, padding, startY + index * 65);
                });
            }

            drawAuthor(source) {
                const { padding, authorColor } = this.templateConfig;
                const authorY = 680;
                
                this.ctx.fillStyle = authorColor;
                this.ctx.font = '28px "Microsoft YaHei", sans-serif';
                this.ctx.textAlign = 'left';
                
                const authorName = source || 'AIæ¨-ä¸“æ³¨AIç§‘æŠ€æ–°é—»';
                this.ctx.fillText(authorName, padding, authorY);
            }

            async drawQRCodeArea(newsId) {
                const { width, padding, qrSize } = this.templateConfig;
                
                const qrY = 950;
                const qrX = padding;
                
                const newsUrl = `https://news.aipush.fun/#/news/${newsId}`;
                
                const qrApis = [
                    `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent(newsUrl)}&format=png&margin=1&ecc=H&color=000000&bgcolor=ffffff`,
                    `https://quickchart.io/qr?text=${encodeURIComponent(newsUrl)}&size=${qrSize}&format=png&ecLevel=H&margin=1&dark=000000&light=ffffff`
                ];
                
                let qrGenerated = false;
                
                for (const apiUrl of qrApis) {
                    try {
                        const img = await this.loadImageWithTimeout(apiUrl, 5000);
                        this.ctx.drawImage(img, qrX, qrY, qrSize, qrSize);
                        qrGenerated = true;
                        break;
                    } catch (error) {
                        continue;
                    }
                }
                
                if (!qrGenerated) {
                    this.drawQRPlaceholder(qrX, qrY, qrSize);
                }
                
                this.ctx.fillStyle = '#666666';
                this.ctx.font = '24px "Microsoft YaHei", sans-serif';
                this.ctx.textAlign = 'left';
                
                const textX = qrX + qrSize + 20;
                this.ctx.fillText('é•¿æŒ‰è¯†åˆ«äºŒç»´ç ', textX, qrY + 35);
                this.ctx.fillText('é˜…è¯»æ–‡ç« ', textX, qrY + 70);
            }

            drawQRPlaceholder(x, y, size) {
                this.ctx.fillStyle = '#ffffff';
                this.ctx.fillRect(x, y, size, size);
                
                this.ctx.strokeStyle = '#000000';
                this.ctx.lineWidth = 2;
                this.ctx.strokeRect(x, y, size, size);
                
                this.ctx.fillStyle = '#000000';
                const cellSize = size / 21;
                
                this.drawFinderPattern(x + cellSize, y + cellSize, cellSize * 7);
                this.drawFinderPattern(x + cellSize * 13, y + cellSize, cellSize * 7);
                this.drawFinderPattern(x + cellSize, y + cellSize * 13, cellSize * 7);
            }

            drawFinderPattern(x, y, size) {
                const cellSize = size / 7;
                
                this.ctx.fillRect(x, y, size, size);
                
                this.ctx.fillStyle = '#ffffff';
                this.ctx.fillRect(x + cellSize, y + cellSize, cellSize * 5, cellSize * 5);
                
                this.ctx.fillStyle = '#000000';
                this.ctx.fillRect(x + cellSize * 2, y + cellSize * 2, cellSize * 3, cellSize * 3);
            }

            drawBrandLogo() {
                const { width, height } = this.templateConfig;
                
                // çº¢è‰²èƒŒæ™¯çŸ©å½¢ (è°ƒæ•´å®½åº¦ä»¥å®¹çº³æ›´å¤šæ–‡å­—)
                this.ctx.fillStyle = '#ff4757';
                this.ctx.fillRect(width - 160, height - 100, 140, 80);
                
                // ç™½è‰²"AIæ¨"æ–‡å­—
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = 'bold 20px "Microsoft YaHei", sans-serif';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('AIæ¨', width - 90, height - 70);
                
                // ç½‘å€æ–‡å­—
                this.ctx.font = '12px "Microsoft YaHei", sans-serif';
                this.ctx.fillText('news.aipush.fun', width - 90, height - 45);
            }

            wrapText(text, maxWidth) {
                const characters = text.split('');
                const lines = [];
                let currentLine = '';

                for (const char of characters) {
                    const testLine = currentLine + char;
                    const metrics = this.ctx.measureText(testLine);
                    
                    if (metrics.width > maxWidth && currentLine !== '') {
                        lines.push(currentLine);
                        currentLine = char;
                    } else {
                        currentLine = testLine;
                    }
                }
                
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                return lines;
            }

            loadImageWithTimeout(src, timeout = 5000) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    const timer = setTimeout(() => {
                        reject(new Error('å›¾ç‰‡åŠ è½½è¶…æ—¶'));
                    }, timeout);
                    
                    img.onload = () => {
                        clearTimeout(timer);
                        resolve(img);
                    };
                    
                    img.onerror = () => {
                        clearTimeout(timer);
                        reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
                    };
                    
                    img.src = src;
                });
            }
        }

        const posterService = new SimplePosterService();

        async function generatePoster() {
            const generateBtn = document.getElementById('generateBtn');
            const status = document.getElementById('status');
            const preview = document.getElementById('posterPreview');
            const downloadBtn = document.getElementById('downloadBtn');
            
            if (generateBtn.disabled) return;
            
            generateBtn.disabled = true;
            generateBtn.textContent = 'ğŸ”„ ç”Ÿæˆä¸­...';
            status.innerHTML = '<div class="loading">â³ æ­£åœ¨ç”Ÿæˆå¤´æ¡æ ·å¼æµ·æŠ¥ï¼Œè¯·ç¨å€™...</div>';
            
            try {
                const newsData = {
                    id: `news_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    title: document.getElementById('titleInput').value || 'é»˜è®¤æ–°é—»æ ‡é¢˜',
                    summary: document.getElementById('summaryInput').value || 'é»˜è®¤æ–°é—»æ‘˜è¦',
                    publishedAt: document.getElementById('dateInput').value,
                    source: document.getElementById('sourceInput').value || 'AIæ¨'
                };
                
                const imageResult = await posterService.generateSimplePoster(newsData);
                currentPosterData = imageResult;
                
                preview.innerHTML = `<img src="${imageResult}" class="poster-preview" alt="ç”Ÿæˆçš„æµ·æŠ¥" />`;
                status.innerHTML = '<div class="success">âœ… æµ·æŠ¥ç”ŸæˆæˆåŠŸï¼æ ·å¼å®Œå…¨æŒ‰ç…§å¤´æ¡é£æ ¼è®¾è®¡</div>';
                downloadBtn.style.display = 'block';
                
            } catch (error) {
                status.innerHTML = '<div class="error">âŒ ç”Ÿæˆå¤±è´¥ï¼š' + error.message + '</div>';
                preview.innerHTML = '<p style="color: #999; padding: 40px;">ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•</p>';
                downloadBtn.style.display = 'none';
            }
            
            generateBtn.disabled = false;
            generateBtn.textContent = 'ğŸš€ ç”Ÿæˆå¤´æ¡æ ·å¼æµ·æŠ¥';
        }

        function downloadPoster() {
            if (!currentPosterData) return;
            
            const link = document.createElement('a');
            link.download = `å¤´æ¡æ ·å¼æµ·æŠ¥_${new Date().getTime()}.png`;
            link.href = currentPosterData;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>