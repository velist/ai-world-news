<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€æ´æµ·æŠ¥ç”Ÿæˆæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        textarea {
            height: 120px;
            resize: vertical;
        }
        .generate-btn {
            background: #007AFF;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin: 20px 0;
        }
        .generate-btn:hover {
            background: #0056CC;
        }
        .generate-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 30px;
            text-align: center;
        }
        .result img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.generating {
            background: #e3f2fd;
            color: #1976d2;
        }
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸš€ æç®€æµ·æŠ¥ç”Ÿæˆæµ‹è¯•</h1>
        <p>æµ‹è¯•æ–°çš„ç®€æ´æµ·æŠ¥æ¨¡æ¿ï¼šåªåŒ…å«æ ‡é¢˜ã€æ‘˜è¦ã€äºŒç»´ç </p>
        
        <form id="posterForm">
            <div class="input-group">
                <label for="title">æ–°é—»æ ‡é¢˜ï¼š</label>
                <input type="text" id="title" placeholder="è¾“å…¥æ–°é—»æ ‡é¢˜..." 
                       value="Metaä¸PIMCOè¾¾æˆ290äº¿ç¾å…ƒAIæ•°æ®ä¸­å¿ƒäº¤æ˜“ - ç›®æ ‡è‚¡ä»·">
            </div>
            
            <div class="input-group">
                <label for="summary">æ–°é—»æ‘˜è¦ï¼ˆ150å­—ä»¥å†…ï¼‰ï¼š</label>
                <textarea id="summary" placeholder="è¾“å…¥æ–°é—»æ‘˜è¦...">Meta å·²é€‰æ‹© PIMCO å’Œ Blue Owl Capital é¢†å¯¼ä¸€é¡¹æ€»é¢ä¸º 290 äº¿ç¾å…ƒçš„èèµ„ï¼Œç”¨äºåœ¨è·¯æ˜“æ–¯å®‰é‚£å·å†œæ‘åœ°åŒºæ‰©å»ºå¤§å‹ AI æ•°æ®ä¸­å¿ƒã€‚è¯¥äº¤æ˜“æ ‡å¿—ç€ç§‘æŠ€å·¨å¤´åœ¨AIåŸºç¡€è®¾æ–½æŠ•èµ„æ–¹é¢çš„é‡å¤§çªç ´ã€‚</textarea>
            </div>
            
            <button type="submit" class="generate-btn" id="generateBtn">
                ğŸ¨ ç”Ÿæˆç®€æ´æµ·æŠ¥
            </button>
        </form>
        
        <div id="status" class="status" style="display: none;"></div>
        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script>
        // ç®€åŒ–çš„æµ·æŠ¥ç”ŸæˆæœåŠ¡ï¼ˆå†…è”ç‰ˆæœ¬ï¼‰
        class SimplePosterService {
            constructor() {
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                
                this.templateConfig = {
                    width: 600,
                    height: 800,
                    backgroundColor: '#ffffff',
                    borderColor: '#4285f4',
                    borderWidth: 3,
                    textColor: '#333333',
                    brandColor: '#666666',
                    padding: 40,
                    qrSize: 120
                };
            }
            
            async generateSimplePoster(newsData) {
                const config = this.templateConfig;
                
                this.canvas.width = config.width;
                this.canvas.height = config.height;
                
                this.ctx.imageSmoothingEnabled = true;
                this.ctx.imageSmoothingQuality = 'high';
                
                // 1. ç™½è‰²èƒŒæ™¯
                this.ctx.fillStyle = config.backgroundColor;
                this.ctx.fillRect(0, 0, config.width, config.height);
                
                // 2. è“è‰²è¾¹æ¡†
                this.ctx.strokeStyle = config.borderColor;
                this.ctx.lineWidth = config.borderWidth;
                this.ctx.strokeRect(
                    config.padding / 2, 
                    config.padding / 2, 
                    config.width - config.padding, 
                    config.height - config.padding
                );
                
                // 3. æ ‡é¢˜
                this.drawTitle(newsData.title, config);
                
                // 4. æ‘˜è¦
                this.drawSummary(newsData.summary, config);
                
                // 5. äºŒç»´ç 
                await this.drawQRCode(newsData.id, config);
                
                // 6. å“ç‰Œä¿¡æ¯
                this.drawBrandInfo(config);
                
                return this.canvas.toDataURL('image/png', 1.0);
            }
            
            drawTitle(title, config) {
                this.ctx.fillStyle = config.textColor;
                this.ctx.font = 'bold 36px "Microsoft YaHei", sans-serif';
                this.ctx.textAlign = 'center';
                
                const maxWidth = config.width - config.padding * 2;
                const lines = this.wrapText(title, maxWidth);
                
                const startY = config.padding + 60;
                lines.slice(0, 2).forEach((line, index) => {
                    this.ctx.fillText(line, config.width / 2, startY + index * 50);
                });
            }
            
            drawSummary(summary, config) {
                const truncatedSummary = summary.length > 150 ? 
                    summary.substring(0, 147) + '...' : summary;
                
                this.ctx.fillStyle = config.textColor;
                this.ctx.font = '24px "Microsoft YaHei", sans-serif';
                this.ctx.textAlign = 'center';
                
                const maxWidth = config.width - config.padding * 2;
                const lines = this.wrapText(truncatedSummary, maxWidth);
                
                const startY = config.padding + 200;
                lines.slice(0, 6).forEach((line, index) => {
                    this.ctx.fillText(line, config.width / 2, startY + index * 35);
                });
            }
            
            async drawQRCode(newsId, config) {
                const qrX = (config.width - config.qrSize) / 2;
                const qrY = 520;
                
                const newsUrl = `https://news.aipush.fun/#/news/${newsId}`;
                const qrApiUrl = `https://www.erweicaihong.cn/api?text=${encodeURIComponent(newsUrl)}&size=${config.qrSize}&key=27e94730-7484-11f0-a569-f7f8300803ea`;
                
                try {
                    const img = await this.loadImage(qrApiUrl);
                    
                    // ç™½è‰²èƒŒæ™¯
                    this.ctx.fillStyle = '#ffffff';
                    this.ctx.fillRect(qrX - 5, qrY - 5, config.qrSize + 10, config.qrSize + 10);
                    
                    // ç»˜åˆ¶äºŒç»´ç 
                    this.ctx.drawImage(img, qrX, qrY, config.qrSize, config.qrSize);
                    
                    // è¾¹æ¡†
                    this.ctx.strokeStyle = '#cccccc';
                    this.ctx.lineWidth = 1;
                    this.ctx.strokeRect(qrX - 1, qrY - 1, config.qrSize + 2, config.qrSize + 2);
                } catch (error) {
                    // ç®€å•å ä½ç¬¦
                    this.drawQRPlaceholder(qrX, qrY, config.qrSize);
                }
            }
            
            drawQRPlaceholder(x, y, size) {
                this.ctx.fillStyle = '#ffffff';
                this.ctx.fillRect(x - 5, y - 5, size + 10, size + 10);
                
                this.ctx.fillStyle = '#333333';
                const cellSize = size / 15;
                
                for (let row = 0; row < 15; row++) {
                    for (let col = 0; col < 15; col++) {
                        if ((row + col) % 2 === 0) {
                            this.ctx.fillRect(
                                x + col * cellSize,
                                y + row * cellSize,
                                cellSize,
                                cellSize
                            );
                        }
                    }
                }
                
                this.ctx.strokeStyle = '#cccccc';
                this.ctx.lineWidth = 1;
                this.ctx.strokeRect(x - 1, y - 1, size + 2, size + 2);
            }
            
            drawBrandInfo(config) {
                this.ctx.fillStyle = config.brandColor;
                this.ctx.font = '20px "Microsoft YaHei", sans-serif';
                this.ctx.textAlign = 'center';
                
                this.ctx.fillText('AIæ¨-ä¸“æ³¨AIç§‘æŠ€æ–°é—»', config.width / 2, 720);
            }
            
            wrapText(text, maxWidth) {
                const characters = text.split('');
                const lines = [];
                let currentLine = '';

                for (const char of characters) {
                    const testLine = currentLine + char;
                    const metrics = this.ctx.measureText(testLine);
                    
                    if (metrics.width > maxWidth && currentLine !== '') {
                        lines.push(currentLine);
                        currentLine = char;
                    } else {
                        currentLine = testLine;
                    }
                }
                
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                return lines;
            }
            
            loadImage(src) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => resolve(img);
                    img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
                    
                    setTimeout(() => reject(new Error('åŠ è½½è¶…æ—¶')), 3000);
                    img.src = src;
                });
            }
        }

        // åˆå§‹åŒ–æœåŠ¡
        const posterService = new SimplePosterService();

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('posterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('title').value.trim();
            const summary = document.getElementById('summary').value.trim();
            
            if (!title || !summary) {
                alert('è¯·å¡«å†™æ ‡é¢˜å’Œæ‘˜è¦');
                return;
            }
            
            const generateBtn = document.getElementById('generateBtn');
            const status = document.getElementById('status');
            const result = document.getElementById('result');
            
            // æ˜¾ç¤ºç”Ÿæˆä¸­çŠ¶æ€
            generateBtn.disabled = true;
            generateBtn.textContent = 'â³ ç”Ÿæˆä¸­...';
            status.className = 'status generating';
            status.style.display = 'block';
            status.textContent = 'ğŸ¨ æ­£åœ¨ç”Ÿæˆæµ·æŠ¥ï¼Œè¯·ç¨å€™...';
            result.style.display = 'none';
            
            try {
                const startTime = Date.now();
                
                const newsData = {
                    id: `test_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    title: title,
                    summary: summary
                };
                
                const imageData = await posterService.generateSimplePoster(newsData);
                
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                status.className = 'status success';
                status.textContent = `âœ… æµ·æŠ¥ç”ŸæˆæˆåŠŸï¼ç”¨æ—¶ï¼š${duration}ms`;
                
                // æ˜¾ç¤ºç»“æœ
                result.innerHTML = `
                    <img src="${imageData}" alt="ç”Ÿæˆçš„æµ·æŠ¥">
                    <br>
                    <button onclick="downloadPoster('${imageData}', '${title.substring(0, 20)}.png')" 
                            style="margin-top: 15px; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        ğŸ’¾ ä¸‹è½½æµ·æŠ¥
                    </button>
                `;
                result.style.display = 'block';
                
            } catch (error) {
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                status.className = 'status error';
                status.textContent = `âŒ ç”Ÿæˆå¤±è´¥ï¼š${error.message}`;
                result.style.display = 'none';
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                generateBtn.disabled = false;
                generateBtn.textContent = 'ğŸ¨ ç”Ÿæˆç®€æ´æµ·æŠ¥';
            }
        });

        // ä¸‹è½½åŠŸèƒ½
        function downloadPoster(dataUrl, filename) {
            const link = document.createElement('a');
            link.download = filename;
            link.href = dataUrl;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>